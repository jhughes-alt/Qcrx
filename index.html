
<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QCRx | Persona Gateway</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    [x-cloak] { display: none !important; }
    :root {
      color-scheme: light;
      --bg: #F8FAFC;
      --surface: #FFFFFF;
      --surface-alt: #F1F5F9;
      --surface-muted: #E2E8F0;
      --text: #0F172A;
      --muted: #64748B;
      --muted-2: #94A3B8;
      --border: #E2E8F0;
      --accent: #2563EB;
      --accent-2: #0F766E;
      --skeleton: #E2E8F0;
      --skeleton-highlight: #F8FAFC;
    }
    html.dark {
      color-scheme: dark;
      --bg: #0B1120;
      --surface: #0F172A;
      --surface-alt: #111827;
      --surface-muted: #1F2937;
      --text: #E2E8F0;
      --muted: #94A3B8;
      --muted-2: #64748B;
      --border: #1F2937;
      --accent: #60A5FA;
      --accent-2: #2DD4BF;
      --skeleton: #1F2937;
      --skeleton-highlight: #111827;
    }
    body { font-family: "Space Grotesk", system-ui, sans-serif; }
    .mono { font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, monospace; }
    body {
      background: var(--bg);
      color: var(--text);
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    .bg-white { background-color: var(--surface) !important; transition: background-color 0.2s ease; }
    .bg-white\/90 { background-color: color-mix(in srgb, var(--surface), transparent 10%) !important; transition: background-color 0.2s ease; }
    .bg-white\/80 { background-color: color-mix(in srgb, var(--surface), transparent 20%) !important; transition: background-color 0.2s ease; }
    .bg-slate-50 { background-color: var(--surface-alt) !important; transition: background-color 0.2s ease; }
    .bg-slate-100 { background-color: var(--surface-muted) !important; transition: background-color 0.2s ease; }
    .bg-\[\#F8FAFC\] { background-color: var(--bg) !important; transition: background-color 0.2s ease; }
    .bg-\[\#F1F5F9\] { background-color: var(--surface-alt) !important; transition: background-color 0.2s ease; }
    .text-\[\#1E293B\], .text-\[\#0F172A\] { color: var(--text) !important; transition: color 0.2s ease; }
    .text-\[\#64748B\], .text-slate-500 { color: var(--muted) !important; transition: color 0.2s ease; }
    .text-\[\#94A3B8\], .text-slate-300, .text-slate-100 { color: var(--muted-2) !important; transition: color 0.2s ease; }
    .border-slate-200, .border-slate-300, .border-slate-100 { border-color: var(--border) !important; transition: border-color 0.2s ease; }
    .border-blue-200 { border-color: color-mix(in srgb, var(--accent), transparent 70%) !important; }
    .bg-blue-50 { background-color: color-mix(in srgb, var(--accent), transparent 88%) !important; }
    .bg-emerald-50 { background-color: color-mix(in srgb, #16A34A, transparent 88%) !important; }
    .bg-amber-50 { background-color: color-mix(in srgb, #D97706, transparent 88%) !important; }
    .bg-rose-50 { background-color: color-mix(in srgb, #DC2626, transparent 88%) !important; }
    .text-blue-700 { color: color-mix(in srgb, var(--accent), black 10%) !important; }
    .text-emerald-700 { color: color-mix(in srgb, #16A34A, black 12%) !important; }
    .text-amber-700 { color: color-mix(in srgb, #D97706, black 12%) !important; }
    .text-rose-700 { color: color-mix(in srgb, #DC2626, black 12%) !important; }
    .skeleton {
      position: relative;
      overflow: hidden;
      background: var(--skeleton);
      border-radius: 0.75rem;
    }
    .skeleton::after {
      content: "";
      position: absolute;
      inset: 0;
      transform: translateX(-100%);
      background: linear-gradient(90deg, transparent, var(--skeleton-highlight), transparent);
      animation: shimmer 1.4s infinite;
    }
    @keyframes shimmer {
      100% { transform: translateX(100%); }
    }
    .table-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .tour-highlight {
      position: relative;
      z-index: 60;
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent), transparent 20%), 0 0 0 8px color-mix(in srgb, var(--accent), transparent 80%);
      border-radius: 0.75rem;
    }
    .tour-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      z-index: 50;
      pointer-events: none;
    }
    .tour-tooltip {
      position: fixed;
      z-index: 70;
      max-width: 280px;
      pointer-events: auto;
    }
    .drawer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      z-index: 40;
    }
    .sidebar-kicker {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.35rem 0.85rem;
      border-radius: 999px;
      border: 1px solid #CBD5F5;
      background: #E2E8F0;
      color: #0F172A;
      text-transform: uppercase;
      letter-spacing: 0.35em;
      font-size: 0.6rem;
      font-weight: 700;
    }
    .sidebar-heading {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      border: 1px solid #E2E8F0;
      background: #F8FAFC;
      color: #0F172A;
      text-transform: uppercase;
      letter-spacing: 0.28em;
      font-size: 0.62rem;
      font-weight: 700;
    }
    .toggle-label {
      text-transform: uppercase;
      letter-spacing: 0.22em;
      font-size: 0.62rem;
      font-weight: 700;
    }
    .pulse-green {
      animation: pulse-green 1.6s ease-in-out infinite;
    }
    .pulse-red {
      animation: pulse-red 1.6s ease-in-out infinite;
    }
    @keyframes pulse-green {
      0%, 100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.5); }
      50% { box-shadow: 0 0 0 8px rgba(22, 163, 74, 0); }
    }
    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.5); }
      50% { box-shadow: 0 0 0 8px rgba(220, 38, 38, 0); }
    }
    .risk-row {
      color: #1E293B;
    }
    .risk-row .risk-muted {
      color: #64748B;
    }
  </style>
</head>
<body class="min-h-screen bg-[#F8FAFC] text-[#1E293B]" x-data="portalData()">
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_top,_rgba(37,99,235,0.12),_transparent_60%)]"></div>
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_bottom,_rgba(20,184,166,0.12),_transparent_60%)]"></div>
  </div>

  <div x-show="notification" class="fixed top-6 right-6 z-50 bg-[#2563EB] text-white px-6 py-3 rounded-xl border border-blue-200 font-semibold" x-transition>
    <span x-text="notification"></span>
  </div>

  <!-- Login Gateway -->
  <section x-show="page === 'login'" class="min-h-screen flex items-center justify-center px-6" x-cloak>
    <div class="max-w-5xl w-full grid md:grid-cols-[1.1fr_1.3fr] gap-10 items-center">
      <div class="space-y-6">
        <div class="inline-flex items-center gap-3 bg-white px-4 py-2 rounded-full text-xs uppercase tracking-[0.35em] text-[#64748B] border border-slate-200">
          Persona Gateway
        </div>
        <h1 class="text-4xl md:text-5xl font-semibold leading-tight">QCRx MSO Operational Command</h1>
        <p class="text-[#64748B] text-lg">The Unified Backbone for Chronic Disease Management. Synchronizing Pharmacist dispensing hardware with NP clinical oversight and automated revenue engines.</p>
        <div class="flex flex-wrap gap-3 text-xs text-[#64748B]">
          <span class="mono bg-white px-3 py-1 rounded-full border border-slate-200">CMS 2026 Audit Ready</span>
          <span class="mono bg-white px-3 py-1 rounded-full border border-slate-200">Hashed/Verified Logs</span>
          <span class="mono bg-white px-3 py-1 rounded-full border border-slate-200">RTM 98975 â€¢ 98977 â€¢ 98980</span>
        </div>
      </div>
      <div class="bg-white border border-slate-200 rounded-xl p-8">
        <h2 class="text-xl font-semibold mb-6">Select Persona</h2>
        <div class="space-y-4">
          <button @click="switchPersona('clinical')" class="w-full flex items-center justify-between px-5 py-4 rounded-xl bg-white border border-slate-200 hover:border-[#2563EB] transition">
            <div>
              <p class="font-semibold">Clinical (NP)</p>
              <p class="text-xs text-[#64748B]">Patient Oversight &amp; Triage. Review adherence alerts, log clinical minutes, and manage risk-based interventions.</p>
            </div>
            <span class="text-2xl text-[#0F172A]">ðŸ©º</span>
          </button>
          <button @click="switchPersona('pharmacy')" class="w-full flex items-center justify-between px-5 py-4 rounded-xl bg-white border border-slate-200 hover:border-[#2563EB] transition">
            <div>
              <p class="font-semibold">Pharmacy (Logistics)</p>
              <p class="text-xs text-[#64748B]">Fulfillment &amp; Enrollment. Scale patient intake and manage GPS-verified delivery logistics through the Ledger.</p>
            </div>
            <span class="text-2xl text-[#0F172A]">ðŸ’Š</span>
          </button>
          <button @click="switchPersona('finance')" class="w-full flex items-center justify-between px-5 py-4 rounded-xl bg-white border border-slate-200 hover:border-[#2563EB] transition">
            <div>
              <p class="font-semibold">Finance (Strategy)</p>
              <p class="text-xs text-[#64748B]">Growth &amp; Revenue Matrix. Model your staircase scaling, track RTM billing codes, and audit logistics credits.</p>
            </div>
            <span class="text-2xl text-[#0F172A]">ðŸ“ˆ</span>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Clinical Triage Suite -->
  <section x-show="page === 'clinical'" x-cloak class="min-h-screen">
    <nav class="sticky top-0 z-40 bg-white/90 border-b border-slate-200 backdrop-blur">
      <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
        <div class="font-semibold tracking-tight">QCRx <span class="text-[#2563EB]">Clinical Triage</span></div>
        <div class="flex items-center gap-3 text-xs">
          <div class="flex items-center gap-2 text-sm">
            <button @click="switchPersona('clinical')" class="px-2 py-1 rounded-lg border" :class="page === 'clinical' ? 'border-blue-200 bg-blue-50 text-[#2563EB] font-semibold' : 'border-slate-200 text-slate-500'" aria-label="Clinical Persona">ðŸ©º</button>
            <button @click="switchPersona('pharmacy')" class="px-2 py-1 rounded-lg border" :class="page === 'pharmacy' ? 'border-blue-200 bg-blue-50 text-[#2563EB] font-semibold' : 'border-slate-200 text-slate-500'" aria-label="Pharmacy Persona">ðŸ’Š</button>
            <button @click="switchPersona('finance')" class="px-2 py-1 rounded-lg border" :class="page === 'finance' ? 'border-blue-200 bg-blue-50 text-[#2563EB] font-semibold' : 'border-slate-200 text-slate-500'" aria-label="Finance Persona">ðŸ“ˆ</button>
          </div>
          <button @click="startTour('clinical')" class="px-3 py-1 rounded-lg border border-slate-200 text-[#2563EB] font-semibold" aria-label="Help tour">? Help</button>
          <button @click="toggleTheme()" class="px-3 py-1 rounded-lg border border-slate-200 text-[#64748B] hover:text-[#0F172A]" aria-label="Toggle dark mode">
            <span x-text="isDark ? 'â˜¾ Dark' : 'â˜€ Light'"></span>
          </button>
          <button @click="goToLogin()" class="px-3 py-1 rounded-lg border border-slate-200 text-[#64748B] hover:text-[#0F172A]">Back</button>
          <button @click="goToLogin()" class="px-3 py-1 rounded-lg border border-slate-200 text-[#64748B] hover:text-[#0F172A]">Log Out</button>
        </div>
      </div>
    </nav>
    <main class="max-w-6xl mx-auto px-6 py-10 space-y-8">
      <header class="flex flex-wrap items-end justify-between gap-4">
        <div>
          <h2 class="text-3xl font-semibold">Triage Queue</h2>
          <p class="text-[#64748B]">Sorted by Risk Status. Red flags trigger at 16-day adherence deficits or symptom keywords.</p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <button @click="showClinicalDrawer = true" class="lg:hidden px-3 py-2 rounded-lg border border-slate-200 text-xs text-[#64748B]">Open Sidebar</button>
          <div class="flex items-center gap-2 text-[10px] uppercase tracking-[0.25em] text-[#64748B] bg-white border border-slate-200 rounded-full px-3 py-1">
            <span>Sort</span>
            <button @click="triageSort = 'risk'; setTriagePage(1)" class="px-2 py-1 rounded-full text-[10px] font-semibold" :class="triageSort === 'risk' ? 'bg-[#2563EB] text-white' : 'text-[#64748B]'">Risk</button>
            <button @click="triageSort = 'adherence'; setTriagePage(1)" class="px-2 py-1 rounded-full text-[10px] font-semibold" :class="triageSort === 'adherence' ? 'bg-[#0F766E] text-white' : 'text-[#64748B]'">Adherence Deficit</button>
            <button @click="triageSort = 'billing'; setTriagePage(1)" class="px-2 py-1 rounded-full text-[10px] font-semibold" :class="triageSort === 'billing' ? 'bg-amber-500 text-white' : 'text-[#64748B]'">Billing Readiness</button>
          </div>
          <div id="risk-badges" class="flex gap-2 text-xs mono" :class="tourHighlight === 'risk-badges' ? 'tour-highlight' : ''">
            <span class="px-3 py-1 rounded-full bg-white text-rose-700 border border-rose-200">RED â€¢ immediate</span>
            <span class="px-3 py-1 rounded-full bg-white text-amber-700 border border-amber-200">YELLOW â€¢ review</span>
            <span class="px-3 py-1 rounded-full bg-white text-emerald-700 border border-emerald-200">GREEN â€¢ stable</span>
          </div>
          <button id="load-demo-button" @click="loadDemoPatients()" class="px-4 py-2 rounded-lg bg-[#2563EB] text-white text-xs font-semibold" :class="tourHighlight === 'load-demo-button' ? 'tour-highlight' : ''">Load Demo Patients</button>
        </div>
      </header>

      <div class="grid lg:grid-cols-[minmax(0,1fr)_320px] gap-6 items-start">
        <div class="space-y-8">
          <div x-show="isLoading" class="bg-[#ffffff] border border-[#E2E8F0] rounded-xl p-6 space-y-4" aria-hidden="true">
            <div class="skeleton h-6 w-40"></div>
            <div class="skeleton h-10 w-full"></div>
            <div class="skeleton h-10 w-full"></div>
            <div class="skeleton h-10 w-full"></div>
            <div class="skeleton h-10 w-full"></div>
          </div>
          <div x-show="!isLoading && triagePatients.length === 0" class="bg-[#ffffff] border border-[#E2E8F0] rounded-xl p-8 text-center">
            <p class="text-sm uppercase tracking-[0.3em] text-[#64748B]">Triage Queue Empty</p>
            <h3 class="text-2xl font-semibold mt-4">No patients in the queue yet.</h3>
            <p class="text-sm text-[#64748B] mt-2">Load demo patients to populate risk statuses, adherence gaps, and billing readiness for walkthroughs.</p>
            <button @click="loadDemoPatients()" class="mt-5 px-5 py-2 rounded-lg bg-[#2563EB] text-white font-semibold">Load Demo Patients</button>
          </div>
          <div id="triage-queue" class="bg-[#ffffff] border border-[#E2E8F0] rounded-xl overflow-hidden" x-show="!isLoading && triagePatients.length" :class="tourHighlight === 'triage-queue' ? 'tour-highlight' : ''">
            <div class="table-scroll">
              <table class="w-full text-left min-w-[760px]">
                <thead class="text-xs uppercase tracking-[0.25em] text-[#64748B] border-b border-[#E2E8F0] bg-[#F1F5F9] sticky top-0 z-10">
                  <tr>
                    <th class="px-6 py-4">Patient</th>
                    <th class="px-6 py-4">Risk Status</th>
                    <th class="px-6 py-4">Adherence Deficit</th>
                    <th class="px-6 py-4">Days to Bill 98977</th>
                    <th class="px-6 py-4">Lifecycle Tracker</th>
                    <th class="px-6 py-4 text-right">Actions</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-[#E2E8F0]">
                  <template x-for="p in paginatedPatients()" :key="p.id">
                    <tr class="transition cursor-pointer border-l-4" :class="riskRowClass(p)" @click="openPatient(p)">
                      <td class="px-6 py-5">
                        <div class="font-semibold" x-text="p.name"></div>
                        <div class="text-xs risk-muted" x-text="'Last contact: ' + p.lastContact"></div>
                      </td>
                      <td class="px-6 py-5">
                        <div class="flex flex-col gap-2">
                          <span class="px-3 py-1 rounded-full text-xs font-semibold w-fit" :class="riskBadge(p)" x-text="p.riskStatus"></span>
                          <span class="text-xs risk-muted" x-text="p.symptomKeywords.length ? 'Symptoms: ' + p.symptomKeywords.join(', ') : 'No symptom alerts'"></span>
                        </div>
                      </td>
                      <td class="px-6 py-5 text-sm">
                        <div class="flex flex-col gap-2">
                          <span x-text="p.adherenceDays + '/' + p.adherenceTarget + ' days'"></span>
                          <span class="text-xs risk-muted" x-text="p.missedDoses ? (p.missedDoses + ' missed â€¢ last: ' + (p.lastMissed || 'â€”')) : 'No missed doses'"></span>
                          <span x-show="critical98977(p)" class="px-2 py-1 rounded-full text-[10px] font-semibold bg-amber-50 text-amber-700 border border-amber-200 w-fit">Critical for 98977 Fulfillment</span>
                        </div>
                      </td>
                      <td class="px-6 py-5 text-sm">
                        <div class="flex flex-col gap-2">
                          <span class="font-semibold" :class="is98977Urgent(p) ? 'text-rose-700' : 'text-[#1E293B]'" x-text="daysRemainingInCycle(p) + ' days'"></span>
                          <span class="px-2 py-1 rounded-full text-[10px] font-semibold w-fit" :class="is98977Urgent(p) ? 'bg-rose-50 text-rose-700 border border-rose-200' : (needs98977(p) ? 'bg-amber-50 text-amber-700 border border-amber-200' : 'bg-emerald-50 text-emerald-700 border border-emerald-200')" x-text="is98977Urgent(p) ? 'Under 2 days left' : (needs98977(p) ? 'Below 16-day threshold' : '98977 eligible')"></span>
                        </div>
                      </td>
                      <td class="px-6 py-5">
                        <div class="flex flex-wrap gap-2">
                          <template x-for="stage in lifecycleStages(p)" :key="stage.label">
                            <span class="px-2 py-1 rounded-full text-[10px] font-semibold min-w-[80px] text-center" :class="stagePillClass(stage)" x-text="stage.label"></span>
                          </template>
                        </div>
                      </td>
                      <td class="px-6 py-5 text-right">
                        <div class="flex flex-col items-end gap-2">
                          <button @click.stop="openPatient(p)" class="px-4 py-2 rounded-lg min-h-[40px] bg-blue-700 text-white text-xs font-semibold hover:bg-blue-800">Action</button>
                          <button @click.stop="openContactOverlay(p)" class="px-4 py-2 rounded-lg min-h-[40px] border-2 border-teal-600 text-teal-600 text-xs font-semibold hover:bg-teal-600/10">Contact</button>
                        </div>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
            <div class="flex flex-wrap items-center justify-between gap-3 px-6 py-4 border-t border-[#E2E8F0] bg-[#ffffff] text-sm">
              <div class="text-xs text-[#64748B]">
                <span x-text="'Showing ' + triagePageRange().start + '-' + triagePageRange().end + ' of ' + triagePageRange().total + ' patients'"></span>
              </div>
              <div class="flex items-center gap-2 text-xs">
                <button @click="prevTriagePage()" class="px-3 py-1 rounded-lg border border-slate-200 text-[#64748B] hover:text-[#0F172A]" :class="triagePage === 1 ? 'opacity-40 cursor-not-allowed' : ''">Prev</button>
                <span class="px-3 py-1 rounded-full bg-slate-100 text-[#0F172A]" x-text="triagePage + ' / ' + triageTotalPages()"></span>
                <button @click="nextTriagePage()" class="px-3 py-1 rounded-lg border border-slate-200 text-[#64748B] hover:text-[#0F172A]" :class="triagePage === triageTotalPages() ? 'opacity-40 cursor-not-allowed' : ''">Next</button>
              </div>
            </div>
          </div>

          <div x-show="isLoading" class="bg-white border border-slate-200 rounded-xl p-6 space-y-4" aria-hidden="true">
            <div class="skeleton h-5 w-44"></div>
            <div class="skeleton h-20 w-full"></div>
            <div class="skeleton h-20 w-full"></div>
          </div>
          <div id="audit-vault" x-show="!isLoading" class="bg-white/80 border border-slate-200 rounded-xl p-6 backdrop-blur-md" :class="tourHighlight === 'audit-vault' ? 'tour-highlight' : ''">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div>
                <h3 class="text-lg font-semibold">Compliance Audit Vault â€” Immutable Log</h3>
                <p class="text-[#64748B] text-sm mt-1">All interactions are hashed and time-stamped for CMS audit readiness.</p>
              </div>
              <span class="px-3 py-1 rounded-full bg-slate-900 text-white text-xs font-semibold">ðŸ”’ Hashed/Verified</span>
            </div>
            <div class="mt-6 max-h-80 overflow-y-auto space-y-3">
              <template x-for="entry in auditLogEntries(activePatient)" :key="entry.hashId + entry.timestamp">
                <div class="border border-slate-200 rounded-xl p-4 bg-white">
                  <div class="flex flex-wrap items-center justify-between gap-2">
                    <span class="mono text-xs text-[#64748B]" x-text="entry.timestamp"></span>
                    <span class="px-2 py-1 rounded-full text-[10px] font-semibold text-white" :class="entry.typeBadge" x-text="entry.icon + ' ' + entry.type"></span>
                  </div>
                  <p class="text-sm text-[#0F172A] mt-2" x-text="entry.description"></p>
                  <p class="text-xs text-[#64748B] mono mt-2" x-text="truncateHash(entry.hashId)"></p>
                </div>
              </template>
              <p x-show="!activePatient" class="text-sm text-[#64748B]">Select a patient to view immutable audit entries.</p>
            </div>
          </div>
        </div>

        <aside class="hidden lg:block space-y-6 lg:sticky lg:top-24">
          <div x-show="isLoading" class="bg-white border border-slate-200 rounded-xl p-5 space-y-3" aria-hidden="true">
            <div class="skeleton h-4 w-24"></div>
            <div class="skeleton h-6 w-32"></div>
            <div class="skeleton h-20 w-full"></div>
          </div>
          <div x-show="!isLoading" class="bg-white border border-slate-200 rounded-xl p-5">
            <p class="text-xs uppercase tracking-[0.3em] text-[#2563EB]">Clinical Sidebar</p>
            <h3 class="text-lg font-semibold mt-3">Active Patient</h3>
            <div class="mt-3 space-y-2">
              <template x-if="activePatient">
                <div>
                  <p class="font-semibold text-[#0F172A]" x-text="activePatient?.name"></p>
                  <p class="text-xs text-[#64748B]" x-text="'ID: ' + activePatient?.id"></p>
                  <p class="text-xs text-[#64748B]" x-text="'Risk: ' + riskStatus(activePatient).toUpperCase()"></p>
                  <p class="text-xs text-[#64748B]" x-text="'Adherence: ' + activePatient.adherenceDays + ' days'"></p>
                  <template x-if="activePatient">
                    <span class="px-2 py-1 rounded-full text-[10px] font-semibold w-fit" :class="coinsuranceBadge(activePatient).class" x-text="coinsuranceBadge(activePatient).label"></span>
                  </template>
                </div>
              </template>
              <p x-show="!activePatient" class="text-sm text-[#64748B]">Select a patient from the queue to load the documentation view.</p>
            </div>
            <div class="mt-4 flex flex-wrap gap-2 text-xs">
              <button @click="activePatient && openPatient(activePatient)" class="px-3 py-2 rounded-lg bg-[#2563EB] text-white font-semibold" :class="activePatient ? '' : 'opacity-50 cursor-not-allowed'">Open Documentation</button>
              <button @click="activePatient && toggleMonitoring(activePatient)" class="px-3 py-2 rounded-lg border border-slate-200" :class="activePatient ? '' : 'opacity-50 cursor-not-allowed'">Toggle Monitoring</button>
            </div>
          </div>

          <div x-show="isLoading" class="bg-white border border-slate-200 rounded-xl p-5 space-y-3" aria-hidden="true">
            <div class="skeleton h-4 w-36"></div>
            <div class="skeleton h-6 w-full"></div>
            <div class="skeleton h-6 w-full"></div>
          </div>
          <div id="billing-readiness" x-show="!isLoading" class="bg-white border border-slate-200 rounded-xl p-5" :class="tourHighlight === 'billing-readiness' ? 'tour-highlight' : ''">
            <div class="flex items-center justify-between">
              <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Billing Readiness</p>
              <span class="px-2 py-1 rounded-full text-[10px] font-semibold" :class="triagePatients.length === 0 ? 'bg-slate-100 text-slate-500 border border-slate-200' : 'bg-emerald-50 text-emerald-700 border border-emerald-100'" x-text="triagePatients.length === 0 ? 'No Data' : (readyToBillCount() + ' Ready')"></span>
            </div>
            <div class="mt-4 space-y-3 text-sm">
              <template x-for="patient in triagePatients.filter(p => billingReady(p)).slice(0, 3)" :key="patient.id">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="font-semibold" x-text="patient.name"></p>
                    <p class="text-xs text-[#64748B]" x-text="patient.npMinutesLogged + ' mins logged'"></p>
                  </div>
                  <span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-emerald-50 text-emerald-700 border border-emerald-100">READY</span>
                </div>
              </template>
              <p x-show="triagePatients.length === 0" class="text-xs text-[#64748B]">No patients available yet.</p>
              <p x-show="triagePatients.length > 0 && triagePatients.filter(p => billingReady(p)).length === 0" class="text-xs text-[#64748B]">No patients have met the 20-minute threshold.</p>
            </div>
          </div>

          <div x-show="isLoading" class="bg-white border border-slate-200 rounded-xl p-5 space-y-3" aria-hidden="true">
            <div class="skeleton h-4 w-36"></div>
            <div class="skeleton h-16 w-full"></div>
            <div class="skeleton h-16 w-full"></div>
          </div>
          <div x-show="!isLoading" class="bg-white border border-slate-200 rounded-xl p-5">
            <div class="flex items-center justify-between">
              <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Adherence Watchlist</p>
              <span class="px-2 py-1 rounded-full bg-amber-50 text-amber-700 border border-amber-100 text-[10px] font-semibold" x-text="watchlistCount() + ' Critical'"></span>
            </div>
            <div class="mt-4 space-y-3 text-sm">
              <template x-for="patient in triagePatients.filter(p => critical98977(p)).slice(0, 3)" :key="patient.id">
                <div class="border border-slate-200 rounded-xl px-4 py-3 text-sm bg-white">
                  <p class="font-semibold" x-text="patient.name"></p>
                  <p class="text-xs text-[#64748B] mt-1" x-text="patient.adherenceDays + '/' + patient.adherenceTarget + ' days logged'"></p>
                  <div class="h-1 bg-slate-200 rounded-full mt-2 overflow-hidden">
                    <div class="h-full bg-amber-500" :style="'width: ' + Math.min(100, (patient.adherenceDays / patient.adherenceTarget) * 100) + '%'"></div>
                  </div>
                </div>
              </template>
              <p x-show="triagePatients.filter(p => critical98977(p)).length === 0" class="text-xs text-[#64748B]">No patients are within 1-2 days of 98977 fulfillment.</p>
            </div>
          </div>
        </aside>
      </div>
    </main>
    <div x-show="showClinicalDrawer" x-cloak class="fixed inset-0 z-50 lg:hidden">
      <div class="drawer-overlay" @click="showClinicalDrawer = false"></div>
      <div class="absolute right-0 top-0 h-full w-full max-w-sm bg-white border-l border-slate-200 p-6 overflow-y-auto space-y-6">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">Clinical Sidebar</h3>
          <button @click="showClinicalDrawer = false" class="text-[#64748B] hover:text-[#0F172A]">âœ•</button>
        </div>
        <div x-show="bulkUpload.mappingConfirmed" class="bg-white border border-slate-200 rounded-xl p-5">
          <p class="text-xs uppercase tracking-[0.3em] text-[#2563EB]">Clinical Sidebar</p>
          <h3 class="text-lg font-semibold mt-3">Active Patient</h3>
          <div class="mt-3 space-y-2">
            <template x-if="activePatient">
              <div>
                <p class="font-semibold text-[#0F172A]" x-text="activePatient?.name"></p>
                <p class="text-xs text-[#64748B]" x-text="'ID: ' + activePatient?.id"></p>
                <p class="text-xs text-[#64748B]" x-text="'Risk: ' + riskStatus(activePatient).toUpperCase()"></p>
                <p class="text-xs text-[#64748B]" x-text="'Adherence: ' + activePatient.adherenceDays + ' days'"></p>
                <template x-if="activePatient">
                  <span class="px-2 py-1 rounded-full text-[10px] font-semibold w-fit" :class="coinsuranceBadge(activePatient).class" x-text="coinsuranceBadge(activePatient).label"></span>
                </template>
              </div>
            </template>
            <p x-show="!activePatient" class="text-sm text-[#64748B]">Select a patient from the queue to load the documentation view.</p>
          </div>
          <div class="mt-4 flex flex-wrap gap-2 text-xs">
            <button @click="activePatient && openPatient(activePatient)" class="px-3 py-2 rounded-lg bg-[#2563EB] text-white font-semibold" :class="activePatient ? '' : 'opacity-50 cursor-not-allowed'">Open Documentation</button>
            <button @click="activePatient && toggleMonitoring(activePatient)" class="px-3 py-2 rounded-lg border border-slate-200" :class="activePatient ? '' : 'opacity-50 cursor-not-allowed'">Toggle Monitoring</button>
          </div>
        </div>

        <div x-show="bulkUpload.mappingConfirmed" class="bg-white border border-slate-200 rounded-xl p-5">
          <div class="flex items-center justify-between">
            <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Billing Readiness</p>
            <span class="px-2 py-1 rounded-full text-[10px] font-semibold" :class="triagePatients.length === 0 ? 'bg-slate-100 text-slate-500 border border-slate-200' : 'bg-emerald-50 text-emerald-700 border border-emerald-100'" x-text="triagePatients.length === 0 ? 'No Data' : (readyToBillCount() + ' Ready')"></span>
          </div>
          <div class="mt-4 space-y-3 text-sm">
            <template x-for="patient in triagePatients.filter(p => billingReady(p)).slice(0, 3)" :key="patient.id">
              <div class="flex items-center justify-between">
                <div>
                  <p class="font-semibold" x-text="patient.name"></p>
                  <p class="text-xs text-[#64748B]" x-text="patient.npMinutesLogged + ' mins logged'"></p>
                </div>
                <span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-emerald-50 text-emerald-700 border border-emerald-100">READY</span>
              </div>
            </template>
            <p x-show="triagePatients.length === 0" class="text-xs text-[#64748B]">No patients available yet.</p>
            <p x-show="triagePatients.length > 0 && triagePatients.filter(p => billingReady(p)).length === 0" class="text-xs text-[#64748B]">No patients have met the 20-minute threshold.</p>
          </div>
        </div>

        <div x-show="bulkUpload.mappingConfirmed" class="bg-white border border-slate-200 rounded-xl p-5">
          <div class="flex items-center justify-between">
            <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Adherence Watchlist</p>
            <span class="px-2 py-1 rounded-full bg-amber-50 text-amber-700 border border-amber-100 text-[10px] font-semibold" x-text="watchlistCount() + ' Critical'"></span>
          </div>
          <div class="mt-4 space-y-3 text-sm">
            <template x-for="patient in triagePatients.filter(p => critical98977(p)).slice(0, 3)" :key="patient.id">
              <div class="border border-slate-200 rounded-xl px-4 py-3 text-sm bg-white">
                <p class="font-semibold" x-text="patient.name"></p>
                <p class="text-xs text-[#64748B] mt-1" x-text="patient.adherenceDays + '/' + patient.adherenceTarget + ' days logged'"></p>
                <div class="h-1 bg-slate-200 rounded-full mt-2 overflow-hidden">
                  <div class="h-full bg-amber-500" :style="'width: ' + Math.min(100, (patient.adherenceDays / patient.adherenceTarget) * 100) + '%'"></div>
                </div>
              </div>
            </template>
            <p x-show="triagePatients.filter(p => critical98977(p)).length === 0" class="text-xs text-[#64748B]">No patients are within 1-2 days of 98977 fulfillment.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Pharmacy Fulfillment Portal -->
  <section x-show="page === 'pharmacy'" x-cloak class="min-h-screen">
    <nav class="sticky top-0 z-40 bg-white/90 border-b border-slate-200 backdrop-blur">
      <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
        <div class="font-semibold tracking-tight">QCRx <span class="text-[#2563EB]">Pharmacy Logistics</span></div>
        <div class="flex items-center gap-2 text-xs">
          <div class="flex items-center gap-2 text-sm">
            <button @click="switchPersona('clinical')" class="px-2 py-1 rounded-lg border" :class="page === 'clinical' ? 'border-blue-200 bg-blue-50 text-[#2563EB] font-semibold' : 'border-slate-200 text-slate-500'" aria-label="Clinical Persona">ðŸ©º</button>
            <button @click="switchPersona('pharmacy')" class="px-2 py-1 rounded-lg border" :class="page === 'pharmacy' ? 'border-blue-200 bg-blue-50 text-[#2563EB] font-semibold' : 'border-slate-200 text-slate-500'" aria-label="Pharmacy Persona">ðŸ’Š</button>
            <button @click="switchPersona('finance')" class="px-2 py-1 rounded-lg border" :class="page === 'finance' ? 'border-blue-200 bg-blue-50 text-[#2563EB] font-semibold' : 'border-slate-200 text-slate-500'" aria-label="Finance Persona">ðŸ“ˆ</button>
          </div>
          <button @click="startTour('pharmacy')" class="px-3 py-1 rounded-lg border border-slate-200 text-[#2563EB] font-semibold" aria-label="Help tour">? Help</button>
          <button @click="toggleTheme()" class="px-3 py-1 rounded-lg border border-slate-200 text-[#64748B] hover:text-[#0F172A]" aria-label="Toggle dark mode">
            <span x-text="isDark ? 'â˜¾ Dark' : 'â˜€ Light'"></span>
          </button>
          <button @click="showEnrollModal = true" class="px-3 py-1 rounded-lg bg-[#2563EB] text-white font-semibold">+ New Enrollment</button>
          <button @click="goToLogin()" class="px-3 py-1 rounded-lg border border-slate-200 text-[#64748B] hover:text-[#0F172A]">Back</button>
          <button @click="goToLogin()" class="px-3 py-1 rounded-lg border border-slate-200 text-[#64748B] hover:text-[#0F172A]">Log Out</button>
        </div>
      </div>
    </nav>

    <main class="max-w-6xl mx-auto px-6 py-10 space-y-8">
      <div class="grid md:grid-cols-[1.1fr_0.9fr] gap-6">
        <div class="space-y-4">
          <div x-show="isLoading" class="bg-white border border-slate-200 rounded-xl p-6 space-y-3" aria-hidden="true">
            <div class="skeleton h-4 w-40"></div>
            <div class="skeleton h-10 w-full"></div>
          </div>
          <div x-show="!isLoading" class="bg-white border border-slate-200 rounded-xl p-6" id="pharmacy-ledger" :class="tourHighlight === 'pharmacy-ledger' ? 'tour-highlight' : ''">
            <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Active Deliveries</p>
            <div class="mt-4 grid grid-cols-3 gap-4 text-center text-sm">
              <div class="border border-slate-200 rounded-xl p-3 bg-slate-50">
                <p class="text-xs text-[#64748B]">Pending</p>
                <p class="text-xl font-semibold" x-text="deliverySummary().pending"></p>
              </div>
              <div class="border border-slate-200 rounded-xl p-3 bg-slate-50">
                <p class="text-xs text-[#64748B]">In Transit</p>
                <p class="text-xl font-semibold" x-text="deliverySummary().inTransit"></p>
              </div>
              <div class="border border-slate-200 rounded-xl p-3 bg-slate-50">
                <p class="text-xs text-[#64748B]">Completed</p>
                <p class="text-xl font-semibold" x-text="deliverySummary().completed"></p>
              </div>
            </div>
          </div>
          <div x-show="isLoading" class="bg-white border border-slate-200 rounded-xl p-6 space-y-3" aria-hidden="true">
            <div class="skeleton h-4 w-40"></div>
            <div class="skeleton h-12 w-full"></div>
          </div>
          <div x-show="!isLoading" class="bg-white border border-slate-200 rounded-xl p-6" id="logistics-ledger" :class="tourHighlight === 'logistics-ledger' ? 'tour-highlight' : ''">
            <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Logistics Ledger</p>
            <div class="flex items-end justify-between mt-4">
              <div>
                <p class="text-4xl font-semibold text-[#0F172A]" x-text="'$' + logisticsCredits().toLocaleString('en-US', {minimumFractionDigits: 2})"></p>
                <p class="text-sm text-[#64748B]" x-text="formatCurrency(finance.pharmacyReimbursementRate) + ' per GPS-verified delivery'"></p>
              </div>
              <div class="text-xs text-[#64748B] mono">Month-to-date</div>
            </div>
          </div>
        </div>
        <div x-show="isLoading" class="bg-white border border-slate-200 rounded-xl p-6 space-y-3" aria-hidden="true">
          <div class="skeleton h-4 w-40"></div>
          <div class="skeleton h-16 w-full"></div>
          <div class="skeleton h-16 w-full"></div>
        </div>
        <div x-show="!isLoading" class="bg-white border border-slate-200 rounded-xl p-6">
          <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Audit-Trail Sync</p>
          <div class="mt-4 space-y-3">
            <template x-for="audit in auditTrail" :key="audit.batchId">
              <div class="flex items-center justify-between border border-slate-200 rounded-xl px-4 py-3 text-sm bg-white">
                <div>
                  <p class="font-semibold" x-text="audit.batchId"></p>
                  <p class="text-xs text-[#64748B]" x-text="audit.monitoringId"></p>
                </div>
                <span class="text-[#0F766E] text-xs font-semibold">Hashed/Verified</span>
              </div>
            </template>
          </div>
        </div>
      </div>

      <div x-show="isLoading" class="bg-white border border-slate-200 rounded-xl p-6 space-y-4" aria-hidden="true">
        <div class="skeleton h-4 w-40"></div>
        <div class="skeleton h-16 w-full"></div>
        <div class="skeleton h-10 w-full"></div>
      </div>
      <div id="bulk-intake" x-show="!isLoading" class="bg-white border border-slate-200 rounded-xl p-6" :class="tourHighlight === 'bulk-intake' ? 'tour-highlight' : ''">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div>
            <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Bulk Patient Intake</p>
            <p class="text-sm text-[#64748B] mt-2">Upload CSV/Excel files with headers: <span class="mono text-[#1E293B]">patient_full_name</span>, <span class="mono text-[#1E293B]">date_of_birth</span>, <span class="mono text-[#1E293B]">primary_diagnosis_code</span>, <span class="mono text-[#1E293B]">pharmacy_npi_id</span>, <span class="mono text-[#1E293B]">monitoring_device_id</span>.</p>
          </div>
          <button @click="openBulkModal()" class="px-4 py-2 rounded-lg bg-[#2563EB] text-white font-semibold">Bulk Patient Intake</button>
        </div>
        <div class="mt-5">
          <div class="flex items-center justify-between text-xs text-[#64748B] mono">
            <span>Verifying Hashed Records</span>
            <span x-text="bulkUpload.progress + '%'"></span>
          </div>
          <div class="h-2 bg-slate-200 rounded-full mt-2 overflow-hidden">
            <div class="h-full bg-[#0F766E]" :class="bulkUpload.progress < 100 ? 'animate-pulse' : ''" :style="'width: ' + bulkUpload.progress + '%'"></div>
          </div>
        </div>
      </div>

      <div x-show="isLoading" class="bg-white border border-slate-200 rounded-xl p-6 space-y-4" aria-hidden="true">
        <div class="skeleton h-6 w-32"></div>
        <div class="skeleton h-12 w-full"></div>
        <div class="skeleton h-12 w-full"></div>
        <div class="skeleton h-12 w-full"></div>
      </div>
      <div x-show="!isLoading" class="bg-white border border-slate-200 rounded-xl overflow-hidden">
        <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 bg-white">
          <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">GPS Verification Queue</p>
          <button id="gps-verify-button" @click="pharmacyPatients.length ? launchDeliveryVerification(pharmacyPatients[0]) : notify('No deliveries available yet.')" class="px-3 py-1 rounded-lg border border-slate-200 text-xs text-[#2563EB] font-semibold" :class="tourHighlight === 'gps-verify-button' ? 'tour-highlight' : ''">GPS Verify</button>
        </div>
        <div class="table-scroll" id="gps-verify" :class="tourHighlight === 'gps-verify' ? 'tour-highlight' : ''">
          <table class="w-full text-left min-w-[860px]">
            <thead class="text-xs uppercase tracking-[0.25em] text-[#64748B] border-b border-slate-200 bg-[#F1F5F9] sticky top-0 z-10">
              <tr>
                <th class="px-6 py-4">Patient</th>
                <th class="px-6 py-4">Diagnosis</th>
                <th class="px-6 py-4">Delivery Status</th>
                <th class="px-6 py-4">GPS Verification</th>
                <th class="px-6 py-4 text-right">Credit</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-200">
              <template x-for="p in pharmacyPatients" :key="p.id">
                <tr class="odd:bg-slate-50 even:bg-white">
                  <td class="px-6 py-5">
                    <div class="font-semibold" x-text="p.name"></div>
                    <div class="text-xs text-[#64748B]" x-text="p.rxSafeBatch"></div>
                  </td>
                  <td class="px-6 py-5 text-sm" x-text="p.diagnosis"></td>
                  <td class="px-6 py-5 text-sm">
                    <span class="px-3 py-1 rounded-full text-[10px] font-semibold" :class="deliveryStatusBadge(p).class" x-text="deliveryStatusBadge(p).label"></span>
                  </td>
                  <td class="px-6 py-5 text-sm">
                    <button @click="launchDeliveryVerification(p)" class="px-3 py-1 rounded-lg text-xs font-semibold" :class="p.gpsVerified ? 'bg-emerald-50 text-emerald-700 border border-emerald-100' : 'bg-slate-100 text-slate-500 border border-slate-200'">
                      <span x-text="p.gpsVerified ? 'Verified' : 'Verify GPS'"></span>
                    </button>
                  </td>
                  <td class="px-6 py-5 text-right text-sm font-semibold" x-text="p.gpsVerified ? formatCurrency(finance.pharmacyReimbursementRate) : '$0.00'"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </section>

  <!-- Finance/Strategy Matrix -->
  <section x-show="page === 'finance'" x-cloak class="min-h-screen">
    <nav class="sticky top-0 z-40 bg-white/90 border-b border-slate-200 backdrop-blur">
      <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
        <div class="font-semibold tracking-tight">QCRx <span class="text-[#2563EB]">Finance Matrix</span></div>
        <div class="flex items-center gap-3 text-xs">
          <div class="flex items-center gap-2 text-sm">
            <button @click="switchPersona('clinical')" class="px-2 py-1 rounded-lg border" :class="page === 'clinical' ? 'border-blue-200 bg-blue-50 text-[#2563EB] font-semibold' : 'border-slate-200 text-slate-500'" aria-label="Clinical Persona">ðŸ©º</button>
            <button @click="switchPersona('pharmacy')" class="px-2 py-1 rounded-lg border" :class="page === 'pharmacy' ? 'border-blue-200 bg-blue-50 text-[#2563EB] font-semibold' : 'border-slate-200 text-slate-500'" aria-label="Pharmacy Persona">ðŸ’Š</button>
            <button @click="switchPersona('finance')" class="px-2 py-1 rounded-lg border" :class="page === 'finance' ? 'border-blue-200 bg-blue-50 text-[#2563EB] font-semibold' : 'border-slate-200 text-slate-500'" aria-label="Finance Persona">ðŸ“ˆ</button>
          </div>
          <button @click="startTour('finance')" class="px-3 py-1 rounded-lg border border-slate-200 text-[#2563EB] font-semibold" aria-label="Help tour">? Help</button>
          <button @click="toggleTheme()" class="px-3 py-1 rounded-lg border border-slate-200 text-[#64748B] hover:text-[#0F172A]" aria-label="Toggle dark mode">
            <span x-text="isDark ? 'â˜¾ Dark' : 'â˜€ Light'"></span>
          </button>
          <button @click="goToLogin()" class="px-3 py-1 rounded-lg border border-slate-200 text-[#64748B] hover:text-[#0F172A]">Back</button>
          <button @click="goToLogin()" class="px-3 py-1 rounded-lg border border-slate-200 text-[#64748B] hover:text-[#0F172A]">Log Out</button>
        </div>
      </div>
    </nav>
    <main class="max-w-6xl mx-auto px-6 py-10 space-y-8">
      <div class="bg-white/80 border border-slate-200 rounded-xl p-8 backdrop-blur-md">
        <div class="flex flex-wrap justify-between gap-6">
          <div>
            <h2 class="text-3xl font-semibold">Revenue Matrix Modeler</h2>
            <p class="text-[#64748B]">Model revenue stack with staircase growth and contracted NP labor.</p>
            <p class="text-xs text-[#64748B] mt-2">Revenue assumes 16+ days of data transmission (98977) and 20 minutes of interactive communication (98980).</p>
          </div>
          <div class="text-xs text-[#64748B] mono">Staircase: +2 pharmacies/mo (Y1), +5/mo (Y2)</div>
        </div>

        <div class="grid lg:grid-cols-[minmax(0,1fr)_minmax(0,1fr)] gap-8 mt-8 lg:items-start">
          <div id="finance-modeler" class="space-y-6 lg:max-h-[calc(100vh-260px)] lg:overflow-auto lg:pr-2" :class="tourHighlight === 'finance-modeler' ? 'tour-highlight' : ''">
            <div>
              <label class="flex justify-between text-xs uppercase tracking-[0.3em] text-[#64748B]">Starting Pharmacies <span x-text="finance.startPharmacies"></span></label>
              <div class="flex items-center gap-3 mt-3">
                <input type="range" min="1" max="50" step="1" x-model.number="finance.startPharmacies" class="w-full accent-[#2563EB]">
                <input type="number" min="1" max="50" step="1" x-model.number="finance.startPharmacies" class="w-20 bg-white border border-slate-200 rounded-lg px-2 py-1 text-sm">
              </div>
            </div>
            <div>
              <label class="flex justify-between text-xs uppercase tracking-[0.3em] text-[#64748B]">Patients per Pharmacy <span x-text="finance.patientsPerPharmacy"></span></label>
              <div class="flex items-center gap-3 mt-3">
                <input type="range" min="20" max="500" step="10" x-model.number="finance.patientsPerPharmacy" class="w-full accent-[#2563EB]">
                <input type="number" min="20" max="500" step="10" x-model.number="finance.patientsPerPharmacy" class="w-20 bg-white border border-slate-200 rounded-lg px-2 py-1 text-sm">
              </div>
            </div>
            <div>
              <label class="flex justify-between text-xs uppercase tracking-[0.3em] text-[#64748B]">Monthly NP Cost <span x-text="formatCurrency(finance.npMonthlyCost)"></span></label>
              <div class="flex items-center gap-3 mt-3">
                <input type="range" min="6000" max="20000" step="250" x-model.number="finance.npMonthlyCost" class="w-full accent-[#2563EB]">
                <input type="number" min="6000" max="20000" step="250" x-model.number="finance.npMonthlyCost" class="w-24 bg-white border border-slate-200 rounded-lg px-2 py-1 text-sm">
              </div>
              <p class="text-xs text-[#64748B] mt-2">Monthly fully-loaded cost per NP used in staffing calculations.</p>
            </div>
            <div>
              <label class="flex justify-between text-xs uppercase tracking-[0.3em] text-[#64748B]">Pharmacy Cost-Reimbursement Rate (per delivery) <span x-text="formatCurrency(finance.pharmacyReimbursementRate)"></span></label>
              <div class="flex items-center gap-3 mt-3">
                <input type="range" min="10" max="80" step="1" x-model.number="finance.pharmacyReimbursementRate" class="w-full accent-[#2563EB]">
                <input type="number" min="10" max="80" step="1" x-model.number="finance.pharmacyReimbursementRate" class="w-20 bg-white border border-slate-200 rounded-lg px-2 py-1 text-sm">
              </div>
              <p class="text-xs text-[#64748B] mt-2">Negotiable â€” set per MSO contract to reflect actual production and courier costs.</p>
            </div>
            <div class="border border-slate-200 rounded-xl p-4 bg-white">
              <div class="flex flex-wrap items-center justify-between gap-3">
                <div>
                  <p class="text-xs uppercase tracking-[0.3em] text-[#2563EB]">Enable 2026 Revenue Recovery</p>
                  <p class="text-xs text-[#64748B] mt-2">Adds a 15% lift to total revenue to capture partial adherence (98985) + partial management (98979).</p>
                  <p class="text-xs text-[#94A3B8] mt-2">Note: 2026 codes 98985/98979 are partial-period codes. Confirm payer coverage before billing.</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" x-model="finance.enableRecovery" class="sr-only peer">
                  <div class="w-12 h-6 bg-slate-200 rounded-full peer-checked:bg-emerald-500 transition"></div>
                  <span class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow transition peer-checked:translate-x-6"></span>
                </label>
              </div>
            </div>
            <div class="border border-slate-200 rounded-xl p-5 bg-slate-50">
              <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">2026 Static Reference Labels</p>
              <div class="mt-4 space-y-4 text-sm">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="font-semibold">98975 Setup Rate</p>
                    <p class="text-xs text-[#64748B]">One-time</p>
                  </div>
                  <span class="text-lg font-semibold" x-text="formatCurrency(finance.rate98975)"></span>
                </div>
                <div class="flex items-center justify-between">
                  <div>
                    <p class="font-semibold">98977 Device Supply</p>
                    <p class="text-xs text-[#64748B]">Monthly average (30-day cycle)</p>
                  </div>
                  <span class="text-lg font-semibold" x-text="formatCurrency(finance.rate98977)"></span>
                </div>
                <div class="flex items-center justify-between">
                  <div>
                    <p class="font-semibold">98980 Management</p>
                    <p class="text-xs text-[#64748B]">Monthly</p>
                  </div>
                  <span class="text-lg font-semibold" x-text="formatCurrency(finance.rate98980)"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="space-y-6 lg:max-h-[calc(100vh-260px)] lg:overflow-auto lg:pr-2" x-effect="!isLoading && updateRevenueChart()">
            <div class="border border-slate-200 rounded-xl p-5 bg-white">
              <div class="flex items-center justify-between">
                <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">NP Workload Assumptions</p>
                <span class="text-[11px] text-[#94A3B8] mono" x-text="totalRiskMix() + '% total'"></span>
              </div>
              <div class="mt-4 space-y-5">
                <div>
                  <div class="flex items-center justify-between text-xs uppercase tracking-[0.3em] text-[#64748B]">
                    <span>Risk Mix</span>
                    <span class="text-[11px]" x-text="finance.riskMix.red + '% / ' + finance.riskMix.yellow + '% / ' + finance.riskMix.green + '%'"></span>
                  </div>
                  <div class="mt-3 h-3 w-full rounded-full overflow-hidden border border-slate-200 bg-slate-100 flex">
                    <div class="bg-rose-500" :style="'width:' + finance.riskMix.red + '%'"></div>
                    <div class="bg-amber-400" :style="'width:' + finance.riskMix.yellow + '%'"></div>
                    <div class="bg-emerald-500" :style="'width:' + finance.riskMix.green + '%'"></div>
                  </div>
                  <div class="mt-4 space-y-3 text-sm">
                    <div>
                      <div class="flex items-center justify-between text-xs">
                        <span class="font-semibold text-rose-700">% RED patients</span>
                        <span x-text="finance.riskMix.red + '%'"></span>
                      </div>
                      <div class="flex items-center gap-3 mt-2">
                        <input type="range" min="0" max="100" step="1" x-model.number="finance.riskMix.red" @input="normalizeRiskMix('red')" class="w-full accent-rose-500">
                        <input type="number" min="0" max="100" step="1" x-model.number="finance.riskMix.red" @input="normalizeRiskMix('red')" class="w-20 bg-white border border-slate-200 rounded-lg px-2 py-1 text-xs">
                      </div>
                    </div>
                    <div>
                      <div class="flex items-center justify-between text-xs">
                        <span class="font-semibold text-amber-700">% YELLOW patients</span>
                        <span x-text="finance.riskMix.yellow + '%'"></span>
                      </div>
                      <div class="flex items-center gap-3 mt-2">
                        <input type="range" min="0" max="100" step="1" x-model.number="finance.riskMix.yellow" @input="normalizeRiskMix('yellow')" class="w-full accent-amber-400">
                        <input type="number" min="0" max="100" step="1" x-model.number="finance.riskMix.yellow" @input="normalizeRiskMix('yellow')" class="w-20 bg-white border border-slate-200 rounded-lg px-2 py-1 text-xs">
                      </div>
                    </div>
                    <div>
                      <div class="flex items-center justify-between text-xs">
                        <span class="font-semibold text-emerald-700">% GREEN patients</span>
                        <span x-text="finance.riskMix.green + '%'"></span>
                      </div>
                      <div class="flex items-center gap-3 mt-2">
                        <input type="range" min="0" max="100" step="1" x-model.number="finance.riskMix.green" @input="normalizeRiskMix('green')" class="w-full accent-emerald-500">
                        <input type="number" min="0" max="100" step="1" x-model.number="finance.riskMix.green" @input="normalizeRiskMix('green')" class="w-20 bg-white border border-slate-200 rounded-lg px-2 py-1 text-xs">
                      </div>
                    </div>
                  </div>
                </div>
                <div>
                  <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Minutes per patient by risk tier</p>
                  <div class="mt-3 grid sm:grid-cols-3 gap-3 text-sm">
                    <div class="border border-rose-200 rounded-lg p-3 bg-rose-50">
                      <p class="text-xs font-semibold text-rose-700">RED</p>
                      <div class="flex items-center gap-2 mt-2">
                        <input type="number" min="1" max="120" step="1" x-model.number="finance.riskMinutes.red" class="w-full bg-white border border-rose-200 rounded-lg px-2 py-1 text-sm">
                        <span class="text-xs text-rose-700">min</span>
                      </div>
                    </div>
                    <div class="border border-amber-200 rounded-lg p-3 bg-amber-50">
                      <p class="text-xs font-semibold text-amber-700">YELLOW</p>
                      <div class="flex items-center gap-2 mt-2">
                        <input type="number" min="1" max="120" step="1" x-model.number="finance.riskMinutes.yellow" class="w-full bg-white border border-amber-200 rounded-lg px-2 py-1 text-sm">
                        <span class="text-xs text-amber-700">min</span>
                      </div>
                    </div>
                    <div class="border border-emerald-200 rounded-lg p-3 bg-emerald-50">
                      <p class="text-xs font-semibold text-emerald-700">GREEN</p>
                      <div class="flex items-center gap-2 mt-2">
                        <input type="number" min="1" max="120" step="1" x-model.number="finance.riskMinutes.green" class="w-full bg-white border border-emerald-200 rounded-lg px-2 py-1 text-sm">
                        <span class="text-xs text-emerald-700">min</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="border border-slate-200 rounded-lg p-3 bg-slate-50">
                  <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Blended Avg Minutes per Patient</p>
                  <p class="text-lg font-semibold mt-2" x-text="blendedAvgMinutes().toFixed(1) + ' min'"></p>
                </div>
              </div>
            </div>
            <div x-show="isLoading" class="grid md:grid-cols-2 gap-6">
              <div class="skeleton h-32 w-full"></div>
              <div class="skeleton h-32 w-full"></div>
              <div class="skeleton h-32 w-full"></div>
              <div class="skeleton h-32 w-full"></div>
            </div>
            <div x-show="isLoading" class="skeleton h-48 w-full"></div>
            <div x-show="isLoading" class="skeleton h-16 w-full"></div>
            <div x-show="!isLoading" id="finance-output" class="grid md:grid-cols-2 gap-6" :class="tourHighlight === 'finance-output' ? 'tour-highlight' : ''">
              <div class="bg-white border border-slate-200 rounded-xl p-5">
                <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Revenue Stack</p>
                <p class="text-sm mt-3">One-Time Onboarding (98975)</p>
                <p class="text-lg font-semibold" x-text="formatCurrency(finance.rate98975)"></p>
                <p class="text-sm mt-3">Avg Monthly (98977 rolling + 98980 calendar)</p>
                <p class="text-lg font-semibold" x-text="formatCurrency(monthlyRecurringPerPatient())"></p>
              </div>
              <div class="bg-white border border-slate-200 rounded-xl p-5">
                <div class="flex items-start justify-between">
                  <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">NP Capacity</p>
                  <span class="text-xs text-[#64748B] border border-slate-200 rounded-full px-2 py-0.5" title="Assumes 160hr/month FTE, 70% RTM utilization = ~6,720 usable minutes. RED patients average 35 min due to escalation and documentation. Adjust tier times to match your NP's actual workflow." aria-label="NP capacity assumptions">i</span>
                </div>
                <div class="mt-4 space-y-3 text-sm">
                  <div class="flex items-center justify-between">
                    <span>Patients per NP per month</span>
                    <span class="font-semibold" x-text="patientsPerNp().toFixed(0)"></span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span>NPs required (current volume)</span>
                    <span class="font-semibold" x-text="npRequiredForPatients(pilotPatientCount())"></span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span>Load status</span>
                    <span class="text-xs font-semibold px-2 py-1 rounded-full border" :class="npLoadStatus().className" x-text="npLoadStatus().label"></span>
                  </div>
                  <p class="text-xs text-[#94A3B8]" x-show="npLoadStatus().note" x-text="npLoadStatus().note"></p>
                </div>
              </div>
              <div class="bg-white border border-slate-200 rounded-xl p-5">
                <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Live Pilot Revenue</p>
                <p class="text-sm text-[#64748B] mt-2" x-text="finance.startPharmacies + ' pharmacies â€¢ ' + pilotPatientCount() + ' patients'"></p>
                <p class="text-3xl font-semibold mt-3" x-text="formatCurrency(livePilotNetProfit())"></p>
                <p class="text-xs uppercase tracking-[0.3em] text-[#64748B] mt-1">Net MSO Profit</p>
                <div class="mt-4 space-y-2 text-xs text-[#64748B]">
                  <div class="flex items-center justify-between">
                    <span>Gross Yield</span>
                    <span x-text="formatCurrency(livePilotGrossRevenue())"></span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span>Logistics Payout</span>
                    <span x-text="'-' + formatCurrency(livePilotLogisticsPayout())"></span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span>NP Labor</span>
                    <span x-text="'-' + formatCurrency(livePilotLaborCost())"></span>
                  </div>
                </div>
              </div>
              <div class="bg-white border border-slate-200 rounded-xl p-5">
                <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Year 1 Projection</p>
                <p class="text-2xl font-semibold mt-3" x-text="formatCurrency(yearProjection(1).total)"></p>
                <p class="text-xs text-[#64748B] mt-2" x-text="yearProjection(1).pharmaciesEnd + ' pharmacies by Dec'" ></p>
              </div>
              <div class="bg-white border border-slate-200 rounded-xl p-5">
                <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Year 2 Projection</p>
                <p class="text-2xl font-semibold mt-3" x-text="formatCurrency(yearProjection(2).total)"></p>
                <p class="text-xs text-[#64748B] mt-2" x-text="yearProjection(2).pharmaciesEnd + ' pharmacies by Dec'" ></p>
              </div>
            </div>
            <div x-show="!isLoading" id="finance-chart" class="bg-white border border-slate-200 rounded-xl p-5" :class="tourHighlight === 'finance-chart' ? 'tour-highlight' : ''">
              <div class="flex items-center justify-between">
                <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">24-Month Revenue Trajectory</p>
                <span class="text-xs text-[#64748B] mono">Cumulative net revenue</span>
              </div>
              <div class="mt-4">
                <canvas x-ref="revenueChart" height="180"></canvas>
              </div>
            </div>
            <div x-show="!isLoading" class="text-xs text-[#64748B] border border-slate-200 bg-white rounded-xl p-4">
              <p class="font-semibold text-[#0F172A]">Compliance Note</p>
              <p>Device supply (98977) requires 16 days of data per 30-day cycle; Management (98980) requires 20 mins + 1 interaction per calendar month.</p>
            </div>
            <div x-show="!isLoading" id="finance-export" class="flex flex-wrap items-center justify-between gap-4 border border-slate-200 bg-white rounded-xl p-5" :class="tourHighlight === 'finance-export' ? 'tour-highlight' : ''">
              <div>
                <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Billing Export</p>
                <p class="text-sm font-semibold mt-2">2026 Compliance Bundle</p>
                <p class="text-xs text-[#64748B] mt-1" x-text="'98977: ' + complianceBundleMetrics().code98977 + ' â€¢ 98980: ' + complianceBundleMetrics().code98980 + ' â€¢ 98985/98979: ' + complianceBundleMetrics().code98985"></p>
              </div>
              <button id="finance-download" @click="downloadComplianceBundle()" class="px-4 py-2 rounded-lg bg-[#0F766E] text-white text-xs font-semibold" :class="tourHighlight === 'finance-download' ? 'tour-highlight' : ''">Download 2026 Compliance Bundle</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </section>

  <!-- Delivery Verification -->
  <section x-show="page === 'delivery'" x-cloak class="min-h-screen bg-[#F8FAFC]">
    <nav class="sticky top-0 z-40 bg-white/90 border-b border-slate-200 backdrop-blur">
      <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
        <div class="font-semibold tracking-tight">QCRx <span class="text-[#2563EB]">Delivery Verify</span></div>
        <div class="flex items-center gap-3 text-xs">
          <div class="flex items-center gap-2 text-sm">
            <button @click="switchPersona('clinical')" class="px-2 py-1 rounded-lg border" :class="page === 'clinical' ? 'border-blue-200 bg-blue-50 text-[#2563EB] font-semibold' : 'border-slate-200 text-slate-500'" aria-label="Clinical Persona">ðŸ©º</button>
            <button @click="switchPersona('pharmacy')" class="px-2 py-1 rounded-lg border" :class="page === 'pharmacy' ? 'border-blue-200 bg-blue-50 text-[#2563EB] font-semibold' : 'border-slate-200 text-slate-500'" aria-label="Pharmacy Persona">ðŸ’Š</button>
            <button @click="switchPersona('finance')" class="px-2 py-1 rounded-lg border" :class="page === 'finance' ? 'border-blue-200 bg-blue-50 text-[#2563EB] font-semibold' : 'border-slate-200 text-slate-500'" aria-label="Finance Persona">ðŸ“ˆ</button>
          </div>
          <button @click="toggleTheme()" class="px-3 py-1 rounded-lg border border-slate-200 text-[#64748B] hover:text-[#0F172A]" aria-label="Toggle dark mode">
            <span x-text="isDark ? 'â˜¾ Dark' : 'â˜€ Light'"></span>
          </button>
          <button @click="switchPersona('pharmacy')" class="px-3 py-1 rounded-lg border border-slate-200 text-[#64748B] hover:text-[#0F172A]">Back to Pharmacy</button>
        </div>
      </div>
    </nav>
    <div class="max-w-md mx-auto px-6 py-10">
      <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm">
        <h2 class="text-xl font-semibold">QCRx Delivery Verification</h2>
        <div class="mt-4 space-y-2 text-sm text-[#64748B]">
          <p><span class="text-[#0F172A] font-semibold">Patient:</span> <span x-text="deliveryPatient()?.name || 'â€”'"></span></p>
          <p><span class="text-[#0F172A] font-semibold">Address:</span> <span x-text="deliveryPatient()?.address || 'Address on file'"></span></p>
          <p><span class="text-[#0F172A] font-semibold">RxSafe Batch:</span> <span x-text="deliveryPatient()?.rxsafeBatchId || 'â€”'"></span></p>
        </div>

        <div class="mt-6 border border-slate-200 rounded-xl p-4 text-center text-sm">
          <p x-show="deliveryState.gpsStatus === 'loading'">ðŸ“ Acquiring GPS...</p>
          <p x-show="deliveryState.gpsStatus === 'ready'">ðŸ“ GPS: <span x-text="deliveryState.coords"></span></p>
          <p x-show="deliveryState.gpsStatus === 'error'" class="text-rose-600">GPS unavailable. Please retry.</p>
        </div>

        <button @click="confirmDelivery()" class="mt-6 w-full rounded-xl bg-[#16A34A] text-white text-lg font-semibold py-5" :class="(deliveryState.confirmed || deliveryState.gpsStatus !== 'ready') ? 'opacity-60 cursor-not-allowed' : ''" :disabled="deliveryState.confirmed || deliveryState.gpsStatus !== 'ready'">
          âœ… HAND-TO-HAND VERIFIED
        </button>

        <div class="mt-6 space-y-2 text-xs text-[#64748B]">
          <p>Timestamp: <span x-text="deliveryState.timestamp || 'â€”'"></span></p>
          <p>GPS: <span x-text="deliveryState.coords || 'â€”'"></span></p>
          <p class="mono" x-show="deliveryState.hashId" x-text="'Hash: ' + deliveryState.hashId"></p>
          <p x-show="deliveryState.confirmed" class="text-emerald-700 font-semibold">âœ… Delivery Confirmed â€” Record Hashed</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Bulk Intake Modal -->
  <div x-show="showBulkModal" x-cloak class="fixed inset-0 z-50 bg-slate-200/70 backdrop-blur flex items-center justify-center p-2 sm:p-6">
    <div class="bg-white border border-slate-200 w-full h-full sm:h-auto sm:max-w-3xl sm:rounded-xl p-6 sm:p-8 overflow-y-auto">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-[#0F766E]">Bulk Patient Intake</p>
          <h3 class="text-2xl font-semibold mt-2">CSV/Excel Upload</h3>
        </div>
        <button @click="closeBulkModal()" class="text-[#64748B] hover:text-[#0F172A]">âœ•</button>
      </div>

      <div class="mt-6 space-y-6">
        <div @dragover.prevent @drop.prevent="handleBulkDrop($event)" class="border border-dashed border-slate-200 rounded-xl p-6 bg-slate-50">
          <input x-ref="bulkFile" type="file" accept=".csv,.xlsx,.xls" class="hidden" @change="handleBulkFile($event)">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
              <p class="text-sm font-semibold">Drop CSV/Excel to begin parsing</p>
              <p class="text-xs text-[#64748B] mt-1" x-text="bulkUpload.fileName ? 'Loaded: ' + bulkUpload.fileName : 'Awaiting file upload...'"></p>
            </div>
            <button @click="$refs.bulkFile.click()" class="px-4 py-2 rounded-lg bg-[#2563EB] text-white font-semibold text-sm">Choose File</button>
          </div>
        </div>

        <div x-show="bulkUpload.mappingConfirmed" class="bg-white border border-slate-200 rounded-xl p-5">
          <div class="flex items-center justify-between">
            <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Mapping Confirmation</p>
            <span class="text-xs" :class="bulkUpload.mappingConfirmed ? 'text-emerald-600' : 'text-amber-600'" x-text="bulkUpload.mappingConfirmed ? 'Confirmed' : 'Needs Review'"></span>
          </div>
          <div class="mt-4 grid md:grid-cols-2 gap-4 text-sm">
            <div class="border border-slate-200 rounded-xl p-4">
              <p class="text-xs uppercase tracking-[0.3em] text-[#64748B] mb-3">Required Fields</p>
              <p class="text-[#334155] mono text-xs">patient_full_name</p>
              <p class="text-[#334155] mono text-xs">date_of_birth</p>
              <p class="text-[#334155] mono text-xs">primary_diagnosis_code</p>
              <p class="text-[#334155] mono text-xs">pharmacy_npi_id</p>
              <p class="text-[#334155] mono text-xs">monitoring_device_id</p>
            </div>
            <div class="border border-slate-200 rounded-xl p-4 space-y-3">
              <div>
                <label class="text-xs text-[#64748B] uppercase tracking-[0.3em]">Patient Name</label>
                <select x-model="bulkUpload.mapping.patientName" @change="bulkUpload.mappingConfirmed = false; buildBulkPreview()" class="mt-2 w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm">
                  <option value="">Unmapped</option>
                  <template x-for="header in bulkUpload.headers" :key="'patient-' + header">
                    <option :value="header" x-text="header"></option>
                  </template>
                </select>
              </div>
              <div>
                <label class="text-xs text-[#64748B] uppercase tracking-[0.3em]">DOB</label>
                <select x-model="bulkUpload.mapping.dob" @change="bulkUpload.mappingConfirmed = false; buildBulkPreview()" class="mt-2 w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm">
                  <option value="">Unmapped</option>
                  <template x-for="header in bulkUpload.headers" :key="'dob-' + header">
                    <option :value="header" x-text="header"></option>
                  </template>
                </select>
              </div>
              <div>
                <label class="text-xs text-[#64748B] uppercase tracking-[0.3em]">ICD-10 Code</label>
                <select x-model="bulkUpload.mapping.icd10" @change="bulkUpload.mappingConfirmed = false; buildBulkPreview()" class="mt-2 w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm">
                  <option value="">Unmapped</option>
                  <template x-for="header in bulkUpload.headers" :key="'icd-' + header">
                    <option :value="header" x-text="header"></option>
                  </template>
                </select>
              </div>
              <div>
                <label class="text-xs text-[#64748B] uppercase tracking-[0.3em]">Pharmacy NPI</label>
                <select x-model="bulkUpload.mapping.pharmacyId" @change="bulkUpload.mappingConfirmed = false; buildBulkPreview()" class="mt-2 w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm">
                  <option value="">Unmapped</option>
                  <template x-for="header in bulkUpload.headers" :key="'pharm-' + header">
                    <option :value="header" x-text="header"></option>
                  </template>
                </select>
              </div>
              <div>
                <label class="text-xs text-[#64748B] uppercase tracking-[0.3em]">Monitoring Device</label>
                <select x-model="bulkUpload.mapping.deviceId" @change="bulkUpload.mappingConfirmed = false; buildBulkPreview()" class="mt-2 w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm">
                  <option value="">Unmapped</option>
                  <template x-for="header in bulkUpload.headers" :key="'device-' + header">
                    <option :value="header" x-text="header"></option>
                  </template>
                </select>
              </div>
            </div>
          </div>
          <div class="mt-4 flex flex-wrap items-center justify-between gap-3">
            <div class="text-xs text-amber-700" x-show="bulkUpload.missingHeaders.length">
              Missing mappings: <span class="mono" x-text="bulkUpload.missingHeaders.join(', ')"></span>
            </div>
            <button @click="confirmBulkMapping()" class="px-4 py-2 rounded-lg bg-[#0F766E] text-white text-xs font-semibold">Confirm Mapping</button>
          </div>
        </div>

        <div class="bg-white border border-slate-200 rounded-xl p-5">
          <div class="flex items-center justify-between">
            <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Sample Rows</p>
            <span class="text-xs text-[#64748B] mono" x-text="bulkUpload.rows.length ? bulkUpload.rows.length + ' rows parsed' : 'No rows parsed'"></span>
          </div>
          <div class="mt-4 table-scroll border border-slate-200 rounded-xl">
            <table class="w-full text-left text-xs">
              <thead class="bg-[#F1F5F9] text-[#64748B] uppercase tracking-[0.3em] sticky top-0">
                <tr>
                  <th class="px-4 py-3">Patient</th>
                  <th class="px-4 py-3">DOB</th>
                  <th class="px-4 py-3">Pharmacy ID</th>
                  <th class="px-4 py-3">ICD-10</th>
                  <th class="px-4 py-3">Status</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-200">
                <template x-for="row in bulkUpload.previewRows" :key="row.id">
                  <tr class="odd:bg-slate-50 even:bg-white">
                    <td class="px-4 py-3" x-text="row.patientName"></td>
                    <td class="px-4 py-3" x-text="row.dob"></td>
                    <td class="px-4 py-3" x-text="row.pharmacyId"></td>
                    <td class="px-4 py-3" x-text="row.icd10"></td>
                    <td class="px-4 py-3">
                      <span class="text-xs font-semibold" :class="row.status.includes('Ineligible') ? 'text-amber-700' : 'text-emerald-700'" x-text="row.status"></span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <p class="text-xs text-[#64748B] mt-3">Rows missing ICD-10 codes are flagged as <span class="text-amber-700">Ineligible for RTM</span> until updated.</p>
        </div>

        <div class="bg-white border border-slate-200 rounded-xl p-5">
          <div class="flex items-center justify-between">
            <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Validate Data</p>
            <span class="text-xs text-[#0F766E]" x-text="bulkUpload.validated ? 'Validated' : 'Pending'"></span>
          </div>
          <div class="mt-4 flex flex-wrap items-center justify-between gap-4">
            <div class="text-xs text-[#64748B] mono">
              <span x-text="bulkUpload.validationSummary.eligible + ' eligible'"></span>
              <span class="mx-2">â€¢</span>
              <span x-text="bulkUpload.validationSummary.ineligible + ' ineligible'"></span>
            </div>
            <div class="flex flex-wrap gap-3">
              <button @click="validateBulkData()" class="px-4 py-2 rounded-lg border border-[#0F766E] text-[#0F766E] text-xs font-semibold disabled:opacity-40" :disabled="!bulkUpload.mappingConfirmed">Validate Data</button>
              <button @click="submitBulkIntake()" class="px-4 py-2 rounded-lg bg-[#2563EB] text-white text-xs font-semibold disabled:opacity-40" :disabled="!bulkUpload.mappingConfirmed || !bulkUpload.validated || bulkUpload.missingHeaders.length">Submit Intake</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enrollment Modal -->
  <div x-show="showEnrollModal" x-cloak class="fixed inset-0 z-50 bg-slate-200/70 backdrop-blur flex items-center justify-center p-2 sm:p-6">
    <div class="bg-white border border-slate-200 w-full h-full sm:h-auto sm:max-w-lg sm:rounded-xl p-6 sm:p-8 overflow-y-auto">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Enrollment Engine</p>
          <h3 class="text-2xl font-semibold mt-2">New Patient Intake</h3>
        </div>
        <button @click="closeEnroll()" class="text-[#64748B] hover:text-[#0F172A]">âœ•</button>
      </div>
      <div class="space-y-4 mt-6">
        <input x-model="enrollForm.name" type="text" placeholder="Patient name" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-sm">
        <input x-model="enrollForm.diagnosis" type="text" placeholder="Primary diagnosis" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-sm">
        <div>
          <label class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Insurance Type</label>
          <select x-model="enrollForm.coinsuranceStatus" class="mt-2 w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-sm" required>
            <option value="" disabled>Select insurance type</option>
            <option value="MEDIGAP â€” $0 copay">Medicare + Medigap Supplement (e.g., Plan F, G, N) â†’ Patient copay: $0</option>
            <option value="ORIGINAL MEDICARE â€” 20% copay (~$21/mo)">Original Medicare Only â†’ Patient copay: ~$21/month (20% coinsurance)</option>
            <option value="MEDICARE ADVANTAGE â€” Verify copay">Medicare Advantage â†’ Patient copay: per plan (verify before enrolling)</option>
            <option value="OTHER / UNKNOWN â€” Verify before billing">Other / Unknown â†’ Flag for verification before billing</option>
          </select>
        </div>
        <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
          <p class="text-xs uppercase tracking-[0.3em] text-[#64748B] mb-3">Twilio Consent Flow</p>
          <div class="flex items-center gap-3 text-sm">
            <template x-for="(step, index) in consentSteps" :key="step">
              <div class="flex items-center gap-2">
                <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs" :class="enrollForm.step >= index ? 'bg-[#2563EB] text-white' : 'bg-white text-[#64748B] border border-slate-200'" x-text="index + 1"></span>
                <span x-text="step" :class="enrollForm.step >= index ? 'text-[#1E293B]' : 'text-[#64748B]'"></span>
              </div>
            </template>
          </div>
          <div class="mt-3 text-xs text-[#64748B]">
            <p class="text-[10px] uppercase tracking-[0.3em] text-[#94A3B8]">SMS 2 Preview</p>
            <p class="mt-2">Medicare-covered Remote Medication Monitoring program. Standard Medicare Part B cost-sharing applies. Patients with supplemental coverage typically pay $0. Reply AGREE to consent or STOP to opt out.</p>
          </div>
          <div class="mt-4 flex justify-between">
            <button @click="prevConsent()" class="text-xs px-3 py-2 rounded-lg border border-slate-200 text-[#64748B]">Previous Step</button>
            <button @click="nextConsent()" class="text-xs px-3 py-2 rounded-lg bg-[#2563EB] text-white font-semibold">Advance</button>
          </div>
        </div>
        <button @click="submitEnrollment()" class="w-full bg-[#2563EB] text-white font-semibold py-3 rounded-lg">Activate Monitoring</button>
      </div>
    </div>
  </div>

  <!-- AI-Assisted Clinical Encounter -->
  <div x-show="showPatientPanel" x-cloak class="fixed inset-0 z-50 bg-[#F8FAFC] overflow-y-auto">
    <div class="min-h-screen">
      <div class="max-w-6xl mx-auto px-6 py-8 space-y-8">
        <div class="flex flex-wrap items-start justify-between gap-4">
          <div>
            <p class="sidebar-kicker">AI-Assisted Clinical Encounter</p>
            <h3 class="text-3xl md:text-4xl font-semibold mt-3" x-text="activePatient?.name"></h3>
            <p class="text-xs text-[#64748B] mt-1" x-text="'Patient ID: ' + activePatient?.id"></p>
          </div>
          <button @click="closePatientPanel()" class="px-3 py-2 rounded-lg border border-slate-200 text-[#64748B] hover:text-[#0F172A]">Close</button>
        </div>

        <div class="bg-white border border-slate-200 rounded-2xl p-5">
          <div class="flex items-center justify-between text-xs uppercase tracking-[0.3em] text-[#64748B]">
            <span x-text="'Step ' + encounterStep + ' of ' + encounterSteps.length"></span>
            <span x-text="encounterSteps[encounterStep - 1]"></span>
          </div>
          <div class="mt-3 h-2 bg-slate-100 rounded-full overflow-hidden">
            <div class="h-full bg-[#2563EB]" :style="'width: ' + encounterProgress() + '%'"></div>
          </div>
          <div class="mt-3 grid grid-cols-5 gap-2 text-[10px] text-[#64748B] uppercase tracking-[0.2em]">
            <template x-for="(stepLabel, index) in encounterSteps" :key="stepLabel">
              <div class="text-center" :class="index + 1 === encounterStep ? 'text-[#2563EB] font-semibold' : ''" x-text="index + 1"></div>
            </template>
          </div>
        </div>

        <div class="grid lg:grid-cols-[1.25fr_0.75fr] gap-6" x-show="encounterStep === 1">
          <div class="bg-white border border-slate-200 rounded-2xl p-6">
            <div class="flex flex-wrap items-start justify-between gap-6">
              <div class="space-y-4">
                <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Identity</p>
                <div class="space-y-2">
                  <p class="text-2xl font-semibold text-[#0F172A]" x-text="activePatient?.name"></p>
                  <p class="text-sm text-[#64748B]" x-text="'DOB: ' + (activePatient?.dob || 'â€”')"></p>
                  <p class="text-sm text-[#64748B]" x-text="'Address: ' + (activePatient?.address || 'â€”')"></p>
                  <p class="text-sm text-[#64748B]" x-text="'Phone: ' + (activePatient?.phone || 'â€”')"></p>
                  <p class="text-sm text-[#64748B]" x-text="'Risk: ' + riskStatus(activePatient).toUpperCase()"></p>
                </div>
              </div>
              <div class="flex flex-col items-start gap-4">
                <a class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-[#2563EB] text-white text-sm font-semibold" :href="activePatient?.phone ? 'tel:' + activePatient.phone : '#'" :class="activePatient?.phone ? '' : 'opacity-50 pointer-events-none'">
                  One-Touch Call
                </a>
                <div class="bg-slate-900 text-white rounded-2xl px-6 py-5 w-full max-w-xs">
                  <p class="text-xs uppercase tracking-[0.3em] text-slate-300">98980 Live Timer</p>
                  <p class="text-4xl font-semibold mt-2" x-text="timerDisplay()"></p>
                  <p class="text-xs text-slate-300 mt-1">Session minutes: <span class="font-semibold text-white" x-text="timerMinutes()"></span></p>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-white border border-slate-200 rounded-2xl p-6 space-y-4">
            <div class="flex items-center justify-between">
              <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Pharmacist Node</p>
              <span class="text-xs font-semibold text-[#0F766E]">98977 Audit Ready</span>
            </div>
            <div class="space-y-3 text-sm">
              <div class="flex items-center justify-between">
                <span class="text-[#64748B]">RxSafe Batch ID</span>
                <span class="font-semibold text-[#0F172A]" x-text="activePatient?.rxsafeBatchId || 'â€”'"></span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-[#64748B]">Courier Delivery Timestamp</span>
                <span class="font-semibold text-[#0F172A]" x-text="activePatient?.deliveryTimestamp || 'â€”'"></span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-[#64748B]">Primary Therapy</span>
                <span class="font-semibold text-[#0F172A]" x-text="activePatient?.medications?.[0] || 'â€”'"></span>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-white border border-slate-200 rounded-2xl p-4 flex items-center gap-2 text-sm" x-show="encounterStep === 1">
          <input type="checkbox" x-model="identityConfirmed" class="accent-[#2563EB]">
          <span>I verified patient identity, contact details, and consent.</span>
        </div>

        <div class="bg-white border border-slate-200 rounded-2xl p-6" x-show="encounterStep === 2">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
              <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Vitals Dashboard</p>
              <h4 class="text-lg font-semibold mt-2">Vitals Trend</h4>
            </div>
            <div class="px-3 py-1 rounded-full bg-amber-50 text-amber-700 border border-amber-100 text-xs font-semibold" x-show="aiFlags.length" x-text="aiFlags[0]"></div>
          </div>
          <div class="mt-6 grid md:grid-cols-2 gap-4">
            <div class="border border-slate-200 rounded-xl p-4">
              <div class="flex items-center justify-between">
                <p class="text-sm font-semibold">Blood Pressure</p>
                <span class="text-xs text-[#64748B]" x-text="latestTrendValue(activePatient?.systolicBp) + '/' + latestTrendValue(activePatient?.diastolicBp) + ' mmHg'"></span>
              </div>
              <svg class="mt-4 w-full h-12" viewBox="0 0 160 48" preserveAspectRatio="none">
                <polyline fill="none" stroke="#2563EB" stroke-width="2" :points="sparklinePoints(activePatient?.systolicBp, 160, 48, 4)"></polyline>
              </svg>
              <p class="text-xs text-[#64748B] mt-2">7-day sparkline â€¢ Î” <span class="font-semibold text-[#0F172A]" x-text="trendDelta(activePatient?.systolicBp)"></span></p>
              <p class="text-xs mt-2 font-semibold" :class="vitalsDeltaFlag(activePatient, 'bp').class" x-text="vitalsDeltaFlag(activePatient, 'bp').label"></p>
            </div>
            <div class="border border-slate-200 rounded-xl p-4">
              <div class="flex items-center justify-between">
                <p class="text-sm font-semibold">Weight</p>
                <span class="text-xs text-[#64748B]" x-text="latestTrendValue(activePatient?.weight) + ' lb'"></span>
              </div>
              <svg class="mt-4 w-full h-12" viewBox="0 0 160 48" preserveAspectRatio="none">
                <polyline fill="none" stroke="#0F766E" stroke-width="2" :points="sparklinePoints(activePatient?.weight, 160, 48, 4)"></polyline>
              </svg>
              <p class="text-xs text-[#64748B] mt-2">7-day sparkline â€¢ Î” <span class="font-semibold text-[#0F172A]" x-text="trendDelta(activePatient?.weight)"></span></p>
              <p class="text-xs mt-2 font-semibold" :class="vitalsDeltaFlag(activePatient, 'weight').class" x-text="vitalsDeltaFlag(activePatient, 'weight').label"></p>
            </div>
          </div>
        </div>
        <div class="bg-white border border-slate-200 rounded-2xl p-4 flex items-center gap-2 text-sm" x-show="encounterStep === 2">
          <input type="checkbox" x-model="vitalsReviewed" class="accent-[#2563EB]">
          <span>Vitals reviewed and changes documented.</span>
        </div>

        <div class="bg-white border border-slate-200 rounded-2xl p-6 space-y-5" x-show="encounterStep === 3">
          <div>
            <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Chief Complaint (AI-Generated)</p>
            <div class="mt-3 border border-slate-200 bg-slate-50 rounded-xl p-4 text-sm text-[#0F172A]" x-show="aiLoading">
              ðŸ¤– Glass Health AI analyzing patient data...
            </div>
            <div class="mt-3 border border-blue-100 bg-blue-50 rounded-xl p-4 text-sm text-[#0F172A]" x-show="!aiLoading">
              <span class="font-semibold">AI Summary:</span>
              <span x-text="aiSummary || 'AI summary pending.'"></span>
            </div>
          </div>

          <div>
            <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">âš  Clinical Flags</p>
            <div class="mt-3 border border-amber-100 bg-amber-50 rounded-xl p-4 text-sm text-amber-900">
              <div class="flex items-center justify-between">
                <p class="font-semibold">Flagged Items</p>
                <span x-show="aiUrgent" class="px-2 py-1 rounded-full text-[10px] font-semibold bg-rose-600 text-white pulse-red">ðŸš¨ URGENT â€” Immediate Action Required</span>
              </div>
              <ul class="mt-2 list-disc list-inside text-xs space-y-1">
                <template x-for="flag in aiFlags" :key="flag">
                  <li x-text="flag"></li>
                </template>
              </ul>
              <p x-show="!aiFlags.length" class="text-xs text-amber-700">No clinical flags detected.</p>
            </div>
          </div>

          <div class="bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm flex items-center gap-2">
            <input type="checkbox" x-model="aiReviewed" class="accent-[#2563EB]">
            <span>Reviewed AI summary and clinical flags.</span>
          </div>
        </div>

        <div class="bg-white border border-slate-200 rounded-2xl p-6 space-y-4" x-show="encounterStep === 4">
          <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Encounter Documentation</p>
          <label class="mt-2 block text-sm font-semibold text-[#0F172A]">AI-Drafted Narrative</label>
          <textarea x-model="aiDraftNote" rows="6" class="mt-2 w-full bg-white border border-slate-200 rounded-xl p-4 text-sm" placeholder="AI-drafted narrative appears here"></textarea>
          <div class="mt-3 flex flex-wrap items-center gap-3">
            <input x-model.number="aiDraftMinutes" type="number" min="0" class="w-28 bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm" placeholder="mins">
            <button @click="draftNarrative()" class="px-4 py-2 rounded-lg border border-slate-200 text-sm font-semibold">Regenerate Draft</button>
          </div>
          <p class="text-xs text-[#94A3B8]">Clinical AI powered by Glass Health â€” evidence-based, guideline-aligned. Not a substitute for clinical judgment. NP review required before logging.</p>
        </div>

        <div class="grid lg:grid-cols-[1.1fr_0.9fr] gap-6" x-show="encounterStep === 5" x-effect="encounterStep === 5 && prepareEncounterHash()">
          <div class="bg-white border border-slate-200 rounded-2xl p-6 space-y-4">
            <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Log &amp; Hash</p>
            <div class="border border-slate-200 rounded-xl p-4 bg-slate-50 text-sm">
              <p class="font-semibold">Ready to seal encounter.</p>
              <p class="text-xs text-[#64748B] mt-2">Minutes logged: <span class="font-semibold" x-text="timerMinutes()"></span> â€¢ Pending hash: <span class="mono" x-text="pendingAuditHash || 'â€”'"></span></p>
            </div>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" x-model="logAcknowledged" class="accent-[#2563EB]">
              <span>I confirm the narrative is complete and ready to hash.</span>
            </label>
            <button @click="approveAndLog()" class="w-full px-6 py-3 rounded-lg bg-[#16A34A] text-white text-sm font-semibold min-h-[48px]" :class="canApproveEncounter() ? '' : 'opacity-50 cursor-not-allowed'" :disabled="!canApproveEncounter()">Approve &amp; Log</button>
          </div>

          <div class="space-y-6">
            <div class="bg-white border border-slate-200 rounded-2xl p-6">
              <div class="flex items-center justify-between">
                <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Twilio Interaction Hash Log</p>
                <span class="text-xs font-semibold text-[#0F766E]">Hashed/Verified</span>
              </div>
              <p class="text-xs text-[#64748B] mt-2">Automated SMS/Voice interactions for the current cycle.</p>
              <div class="mt-4 space-y-3">
                <template x-for="entry in twilioAuditLog" :key="entry.hash">
                  <div class="border border-slate-200 rounded-xl p-3 text-sm">
                    <div class="flex items-center justify-between text-xs text-[#64748B] mono">
                      <span x-text="entry.timestamp"></span>
                      <span x-text="entry.channel"></span>
                    </div>
                    <p class="mt-2" x-text="entry.detail"></p>
                    <p class="text-xs text-[#64748B] mono mt-2" x-text="'Hash: ' + entry.hash"></p>
                  </div>
                </template>
                <p x-show="!twilioAuditLog.length" class="text-xs text-[#64748B]">No automated interactions logged yet.</p>
              </div>
            </div>
            <div class="bg-white border border-slate-200 rounded-2xl p-6">
              <div class="flex items-center justify-between">
                <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Analog Channel</p>
                <span class="text-xs font-semibold text-[#0F766E]">Hashed/Verified</span>
              </div>
              <div class="mt-4 flex items-center justify-between">
                <div>
                  <p class="text-base font-semibold text-[#0F172A]">Monitoring Channel</p>
                  <p class="text-xs text-[#475569]">Switch between SMS (Twilio) and Voice/IVR workflows.</p>
                </div>
                <button @click="toggleMonitoring(activePatient)" role="switch" :aria-checked="activePatient?.monitoring !== 'SMS'" class="relative inline-flex h-10 w-28 items-center rounded-full border border-slate-300 bg-white shadow-sm transition">
                  <span class="absolute left-3 toggle-label" :class="activePatient?.monitoring === 'SMS' ? 'text-[#1D4ED8]' : 'text-[#94A3B8]'">SMS</span>
                  <span class="absolute right-3 toggle-label" :class="activePatient?.monitoring !== 'SMS' ? 'text-[#0F766E]' : 'text-[#94A3B8]'">Voice</span>
                  <span class="h-7 w-7 rounded-full bg-white shadow transition" :class="activePatient?.monitoring === 'SMS' ? 'translate-x-1' : 'translate-x-[80px]'"></span>
                </button>
              </div>
              <div class="mt-4 space-y-3 text-sm">
                <template x-for="entry in engagementLogs(activePatient)" :key="entry.id">
                  <div class="rounded-lg border border-slate-200 bg-white p-3">
                    <div class="flex items-center justify-between text-xs text-[#64748B] mono">
                      <span x-text="entry.timestamp"></span>
                      <span x-text="entry.channel"></span>
                    </div>
                    <p class="mt-2" x-text="entry.detail"></p>
                  </div>
                </template>
                <p x-show="!engagementLogs(activePatient).length" class="text-xs text-[#64748B]">No outreach logs recorded yet.</p>
              </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-2xl p-6">
              <div class="flex items-center justify-between">
                <p class="text-xs uppercase tracking-[0.3em] text-[#64748B]">Audit-Ready Narrative Log</p>
                <span class="text-xs font-semibold text-[#0F766E]">Hashed/Verified</span>
              </div>
              <p class="text-sm text-[#64748B] mt-3">Clinical Minutes Logged: <span class="font-semibold" x-text="totalMinutes(activePatient)"></span> / <span x-text="activePatient?.npMinutesTarget || 20"></span></p>
              <div class="h-2 bg-slate-200 rounded-full mt-2 overflow-hidden">
                <div class="h-full bg-[#0F766E]" :style="'width: ' + Math.min(100, (totalMinutes(activePatient) / (activePatient?.npMinutesTarget || 20)) * 100) + '%' "></div>
              </div>
              <div class="mt-4 space-y-3">
                <template x-for="entry in activePatient?.narrativeLogs" :key="entry.id">
                  <div class="border border-slate-200 rounded-xl p-3 text-sm">
                    <div class="flex justify-between text-xs text-[#64748B] mono">
                      <span x-text="entry.timestamp"></span>
                      <span x-text="entry.minutes + ' mins'"></span>
                    </div>
                    <p class="mt-2" x-text="entry.note"></p>
                    <p class="text-xs text-[#64748B] mono mt-2" x-show="entry.auditHash" x-text="'Audit Hash: ' + entry.auditHash"></p>
                    <p class="text-xs text-[#0F766E] mt-2">Hashed/Verified</p>
                  </div>
                </template>
                <p x-show="!activePatient?.narrativeLogs?.length" class="text-xs text-[#64748B]">No narrative entries logged yet.</p>
              </div>
              <div class="mt-4 space-y-3">
                <textarea x-model="newLog" rows="3" class="w-full bg-white border border-slate-200 rounded-lg p-3 text-sm" placeholder="Add narrative note"></textarea>
                <div class="flex items-center gap-3">
                  <input x-model.number="newMinutes" type="number" min="0" class="w-24 bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm" placeholder="mins">
                  <button @click="addNarrative()" class="px-4 py-2 rounded-lg bg-[#2563EB] text-white text-xs font-semibold">Log Minutes</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex items-center justify-between gap-3">
          <button @click="prevEncounterStep()" class="px-4 py-2 rounded-lg border border-slate-200 text-sm" :class="encounterStep === 1 ? 'opacity-50 cursor-not-allowed' : ''" :disabled="encounterStep === 1">Back</button>
          <button x-show="encounterStep < 5" @click="nextEncounterStep()" class="px-4 py-2 rounded-lg bg-[#2563EB] text-white text-sm font-semibold" :class="canAdvanceEncounter() ? '' : 'opacity-50 cursor-not-allowed'" :disabled="!canAdvanceEncounter()">Next Step</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Communication Overlay -->
  <div x-show="showContactOverlay" x-cloak class="fixed inset-0 z-50 bg-slate-900/40 backdrop-blur flex items-center justify-center p-2 sm:p-6">
    <div class="bg-white border border-slate-200 w-full h-full sm:h-auto sm:max-w-xl sm:rounded-2xl p-6 sm:p-8 overflow-y-auto">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-[#0F766E]">Communication Overlay</p>
          <h3 class="text-2xl font-semibold mt-2">Synchronous Interaction Logged</h3>
        </div>
        <button @click="closeContactOverlay()" class="text-[#64748B] hover:text-[#0F172A]">âœ•</button>
      </div>
      <div class="mt-6 space-y-3 text-sm">
        <p class="text-[#0F172A]"><span class="font-semibold">Patient:</span> <span x-text="contactPatient?.name || 'â€”'"></span></p>
        <p class="text-[#0F172A]"><span class="font-semibold">Channel:</span> Twilio Voice/SMS</p>
        <p class="text-[#0F172A]"><span class="font-semibold">Twilio SID:</span> <span class="mono text-[#0F766E]" x-text="contactSid || 'â€”'"></span></p>
        <p class="text-[#0F172A]"><span class="font-semibold">Timestamp:</span> <span class="mono" x-text="contactTimestamp || 'â€”'"></span></p>
        <div class="bg-slate-50 border border-slate-200 rounded-xl p-4 text-xs text-[#64748B]">
          Interaction logged in Compliance Audit Vault as a synchronous interaction with unique Twilio SID hashing.
        </div>
      </div>
      <div class="mt-6 flex items-center justify-end gap-2">
        <button @click="closeContactOverlay()" class="px-4 py-2 rounded-lg border border-slate-200 text-[#64748B]">Close</button>
      </div>
    </div>
  </div>

  <div x-show="tourActive" x-cloak>
    <div class="tour-overlay"></div>
    <div class="tour-tooltip bg-white border border-slate-200 rounded-xl p-4 shadow-lg" :style="tourStyle">
      <p class="text-[10px] uppercase tracking-[0.3em] text-[#64748B]">Onboarding Tour</p>
      <p class="text-sm font-semibold mt-2" x-text="currentTourStep().title"></p>
      <p class="text-xs text-[#64748B] mt-2" x-text="currentTourStep().text"></p>
      <div class="mt-4 flex items-center justify-between text-xs">
        <span class="text-[#64748B]" x-text="'Step ' + (tourStepIndex + 1) + ' of ' + currentTourSteps().length"></span>
        <div class="flex items-center gap-2">
          <button @click="skipTour()" class="px-3 py-1 rounded-lg border border-slate-200 text-[#64748B]">Skip</button>
          <button @click="nextTourStep()" class="px-3 py-1 rounded-lg bg-[#2563EB] text-white font-semibold" x-text="tourStepIndex + 1 === currentTourSteps().length ? 'Done' : 'Next'"></button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function portalData() {
      const DEMO_PATIENTS = [
        {
          id: "PT-001",
          name: "Garcia, Maria",
          dob: "11/03/1952",
          age: 73,
          address: "1421 Pacific Coast Hwy, Santa Monica, CA",
          phone: "310-555-0142",
          diagnosis: "Type 2 Diabetes (E11.9)",
          icd10: "E11.9",
          medications: ["Metformin 1000mg", "Lisinopril 10mg", "Atorvastatin 40mg"],
          pharmacyNpi: "1234567890",
          deviceId: "RX-00143",
          rxsafeBatchId: "RXSF-2026-00143-FEB",
          riskStatus: "RED",
          adherenceDays: 13,
          adherenceTarget: 16,
          missedDoses: 3,
          lastMissed: "Feb 18, 2026",
          symptomKeywords: ["DIZZY", "TIRED"],
          systolicBp: [148, 152, 145, 158, 150, 155, 148],
          diastolicBp: [92, 95, 90, 98, 93, 96, 94],
          weight: [162, 163, 162, 164, 163, 165, 164],
          deliveryVerified: true,
          deliveryTimestamp: "Feb 03, 2026 â€” 10:42 AM",
          deliveryGps: "34.0195Â° N, 118.4912Â° W",
          consentDate: "Jan 29, 2026",
          consentTwilioSid: "SM3A9F2B1C4D7E8F0A",
          enrollmentDate: "Jan 29, 2026",
          npMinutesLogged: 14,
          npMinutesTarget: 20,
          billingStatus: "98977_PENDING",
          lifecycleStage: ["consent", "delivered", "monitoring"],
          coinsuranceStatus: "MEDIGAP â€” $0 copay",
          lastContact: "Feb 16, 2026"
        },
        {
          id: "PT-002",
          name: "Smith, James",
          dob: "04/12/1948",
          age: 77,
          address: "908 Wilshire Blvd, Santa Monica, CA",
          phone: "310-555-0131",
          diagnosis: "Hypertension (I10)",
          icd10: "I10",
          medications: ["Amlodipine 5mg", "Losartan 50mg", "Aspirin 81mg"],
          pharmacyNpi: "1234567890",
          deviceId: "RX-00142",
          rxsafeBatchId: "RXSF-2026-00142-FEB",
          riskStatus: "GREEN",
          adherenceDays: 16,
          adherenceTarget: 16,
          missedDoses: 0,
          lastMissed: null,
          symptomKeywords: [],
          systolicBp: [138, 135, 132, 136, 130, 128, 132],
          diastolicBp: [85, 83, 82, 84, 80, 79, 82],
          weight: [178, 178, 177, 178, 177, 176, 177],
          deliveryVerified: true,
          deliveryTimestamp: "Feb 02, 2026 â€” 2:15 PM",
          deliveryGps: "34.0205Â° N, 118.4890Â° W",
          consentDate: "Jan 28, 2026",
          consentTwilioSid: "SM7C2D4E6F8A0B1C2D",
          enrollmentDate: "Jan 28, 2026",
          npMinutesLogged: 22,
          npMinutesTarget: 20,
          billingStatus: "READY_TO_BILL",
          lifecycleStage: ["consent", "delivered", "monitoring", "clinical", "billing"],
          coinsuranceStatus: "ORIGINAL MEDICARE â€” 20% copay (~$21/mo)",
          lastContact: "Feb 17, 2026"
        },
        {
          id: "PT-003",
          name: "Johnson, Robert",
          dob: "07/22/1945",
          age: 80,
          address: "112 Ocean Park Blvd, Santa Monica, CA",
          phone: "310-555-0194",
          diagnosis: "COPD (J44.1)",
          icd10: "J44.1",
          medications: ["Tiotropium inhaler", "Albuterol PRN", "Prednisone 5mg"],
          pharmacyNpi: "1234567890",
          deviceId: "RX-00144",
          rxsafeBatchId: "RXSF-2026-00144-FEB",
          riskStatus: "YELLOW",
          adherenceDays: 11,
          adherenceTarget: 16,
          missedDoses: 1,
          lastMissed: "Feb 17, 2026",
          symptomKeywords: ["SHORT OF BREATH"],
          systolicBp: [125, 128, 122, 130, 126, 124, 127],
          diastolicBp: [78, 80, 76, 82, 79, 77, 80],
          weight: [155, 154, 155, 153, 154, 153, 154],
          deliveryVerified: true,
          deliveryTimestamp: "Feb 04, 2026 â€” 11:30 AM",
          deliveryGps: "34.0178Â° N, 118.4955Â° W",
          consentDate: "Jan 30, 2026",
          consentTwilioSid: "SM1B3C5D7E9F0A2B4C",
          enrollmentDate: "Jan 30, 2026",
          npMinutesLogged: 9,
          npMinutesTarget: 20,
          billingStatus: "98977_PENDING",
          lifecycleStage: ["consent", "delivered", "monitoring"],
          coinsuranceStatus: "MEDIGAP â€” $0 copay",
          lastContact: "Feb 15, 2026"
        },
        {
          id: "PT-004",
          name: "Williams, Patricia",
          dob: "09/15/1950",
          age: 75,
          address: "220 Main St, Santa Monica, CA",
          phone: "310-555-0177",
          diagnosis: "Heart Failure (I50.9)",
          icd10: "I50.9",
          medications: ["Furosemide 40mg", "Carvedilol 12.5mg", "Spironolactone 25mg", "Digoxin 0.125mg"],
          pharmacyNpi: "1234567890",
          deviceId: "RX-00145",
          rxsafeBatchId: "RXSF-2026-00145-FEB",
          riskStatus: "RED",
          adherenceDays: 8,
          adherenceTarget: 16,
          missedDoses: 5,
          lastMissed: "Feb 19, 2026",
          symptomKeywords: ["SWOLLEN", "HELP", "FEET SWOLLEN"],
          systolicBp: [155, 162, 158, 168, 160, 165, 170],
          diastolicBp: [96, 100, 97, 104, 99, 102, 106],
          weight: [192, 194, 196, 198, 197, 200, 203],
          deliveryVerified: true,
          deliveryTimestamp: "Feb 05, 2026 â€” 9:00 AM",
          deliveryGps: "34.0215Â° N, 118.4870Â° W",
          consentDate: "Feb 01, 2026",
          consentTwilioSid: "SM9E0F1A2B3C4D5E6F",
          enrollmentDate: "Feb 01, 2026",
          npMinutesLogged: 6,
          npMinutesTarget: 20,
          billingStatus: "ESCALATE",
          lifecycleStage: ["consent", "delivered", "monitoring"],
          coinsuranceStatus: "MEDIGAP â€” $0 copay",
          lastContact: "Feb 14, 2026"
        },
        {
          id: "PT-005",
          name: "Brown, Dorothy",
          dob: "03/08/1955",
          age: 70,
          address: "310 Arizona Ave, Santa Monica, CA",
          phone: "310-555-0128",
          diagnosis: "Type 2 Diabetes + Hypertension (E11.9, I10)",
          icd10: "E11.9",
          medications: ["Insulin Glargine 20u QHS", "Metformin 500mg", "Amlodipine 10mg", "Atorvastatin 20mg"],
          pharmacyNpi: "1234567890",
          deviceId: "RX-00146",
          rxsafeBatchId: "RXSF-2026-00146-FEB",
          riskStatus: "GREEN",
          adherenceDays: 16,
          adherenceTarget: 16,
          missedDoses: 0,
          lastMissed: null,
          symptomKeywords: [],
          systolicBp: [132, 130, 128, 131, 129, 127, 130],
          diastolicBp: [82, 80, 79, 83, 80, 78, 81],
          weight: [168, 167, 168, 167, 166, 167, 166],
          deliveryVerified: true,
          deliveryTimestamp: "Feb 03, 2026 â€” 3:45 PM",
          deliveryGps: "34.0188Â° N, 118.4932Â° W",
          consentDate: "Jan 31, 2026",
          consentTwilioSid: "SM4F5A6B7C8D9E0F1A",
          enrollmentDate: "Jan 31, 2026",
          npMinutesLogged: 21,
          npMinutesTarget: 20,
          billingStatus: "READY_TO_BILL",
          lifecycleStage: ["consent", "delivered", "monitoring", "clinical", "billing"],
          coinsuranceStatus: "MEDICARE ADVANTAGE â€” $0 copay",
          lastContact: "Feb 18, 2026"
        }
      ];
      return {
        page: 'login',
        isLoading: true,
        isDark: false,
        themePreference: 'system',
        showClinicalDrawer: false,
        demoSeeded: false,
        showEnrollModal: false,
        showBulkModal: false,
        showPatientPanel: false,
        showContactOverlay: false,
        activePatient: null,
        contactPatient: null,
        contactSid: '',
        contactTimestamp: '',
        encounterApproved: false,
        notification: '',
        newLog: '',
        newMinutes: 5,
        aiSummary: '',
        aiFlags: [],
        aiLoading: false,
        aiUrgent: false,
        aiDraftNote: '',
        aiDraftMinutes: 5,
        twilioAuditLog: [],
        triageSort: 'risk',
        triagePage: 1,
        triagePerPage: 25,
        timerSeconds: 0,
        timerInterval: null,
        timerRunning: false,
        inactivityTimer: null,
        inactivityTimeoutMs: 15 * 60 * 1000,
        encounterStep: 1,
        encounterSteps: ['Identity Verification', 'Vitals Review', 'AI Summary & Flags', 'Encounter Documentation', 'Log & Hash'],
        identityConfirmed: false,
        vitalsReviewed: false,
        aiReviewed: false,
        logAcknowledged: false,
        pendingAuditHash: '',
        tourActive: false,
        tourPersona: '',
        tourStepIndex: 0,
        tourHighlight: '',
        tourStyle: 'top: 20px; left: 20px;',
        revenueChart: null,
        consentSteps: ['Setup', 'Opt-in', 'Education'],
        enrollForm: { name: '', diagnosis: '', coinsuranceStatus: '', step: 0 },
        bulkUpload: {
          fileName: '',
          headers: [],
          rows: [],
          previewRows: [],
          mapping: { patientName: '', dob: '', pharmacyId: '', icd10: '', deviceId: '' },
          missingHeaders: [],
          mappingConfirmed: false,
          validated: false,
          progress: 0,
          validationSummary: { eligible: 0, ineligible: 0 }
        },
        triagePatients: [],
        pharmacyPatients: [],
        auditTrail: [],
        deliveryState: {
          patientId: '',
          gpsStatus: 'loading',
          coords: '',
          lat: null,
          lng: null,
          timestamp: '',
          hashId: '',
          confirmed: false
        },
        finance: {
          startPharmacies: 1,
          patientsPerPharmacy: 500,
          npMonthlyCost: 12000,
          pharmacyReimbursementRate: 25,
          enableRecovery: false,
          rate98975: 19.65,
          rate98977: 51.00,
          rate98980: 54.11,
          riskMix: {
            red: 20,
            yellow: 40,
            green: 40
          },
          riskMinutes: {
            red: 35,
            yellow: 22,
            green: 12
          }
        },
        init() {
          this.initThemePreference();
          this.triagePatients = [];
          this.pharmacyPatients = [];
          this.auditTrail = [];
          this.setupInactivityTimer();
          this.$watch('page', value => this.onPersonaChange(value));
          window.addEventListener('resize', () => {
            if (this.tourActive) this.updateTourPosition();
          });
          const seeded = localStorage.getItem('qcrxDemoSeeded') === 'true';
          this.demoSeeded = seeded;
          setTimeout(() => {
            if (seeded) {
              this.loadDemoPatients(true);
            }
            this.isLoading = false;
            this.applyRouteFromUrl();
          }, 700);
          window.addEventListener('beforeunload', (event) => {
            if (this.showPatientPanel && !this.encounterApproved && this.timerSeconds > 0) {
              event.preventDefault();
              event.returnValue = '';
            }
          });
        },
        seedTriagePatients() {
          return DEMO_PATIENTS.map(patient => ({
            ...patient,
            monitoring: 'SMS',
            smsLogs: [
              { id: `${patient.id}-sms-1`, timestamp: `${patient.lastContact} â€” 09:00 AM`, channel: 'SMS', detail: 'Daily adherence ping sent. Patient replied: TAKEN.' }
            ],
            ivrLogs: [
              { id: `${patient.id}-ivr-1`, timestamp: `${patient.lastContact} â€” 09:05 AM`, channel: 'IVR', detail: 'Call Successful - Key 1 Pressed' }
            ],
            narrativeLogs: [],
            auditLog: this.generateAuditLog(patient)
          }));
        },
        seedPharmacyPatients() {
          return this.triagePatients.map(patient => ({
            id: patient.id,
            name: patient.name,
            diagnosis: patient.diagnosis,
            gpsVerified: patient.deliveryVerified,
            rxSafeBatch: patient.rxsafeBatchId,
            deliveryTimestamp: patient.deliveryTimestamp,
            deliveryGps: patient.deliveryGps,
            deliveryStatus: patient.deliveryVerified ? 'Completed' : (Math.random() > 0.5 ? 'In Transit' : 'Pending')
          }));
        },
        seedAuditTrail() {
          return this.triagePatients.slice(0, 3).map(patient => ({
            batchId: patient.rxsafeBatchId,
            monitoringId: `Monitor-${patient.id}-${Math.floor(Math.random() * 9000)}`
          }));
        },
        loadDemoPatients(quiet = false) {
          this.triagePatients = this.seedTriagePatients();
          this.pharmacyPatients = this.seedPharmacyPatients();
          this.auditTrail = this.seedAuditTrail();
          this.demoSeeded = true;
          localStorage.setItem('qcrxDemoSeeded', 'true');
          this.setTriagePage(1);
          if (!quiet) {
            this.notify('Demo patients loaded.');
          }
        },
        applyRouteFromUrl() {
          const url = new URL(window.location.href);
          if (url.pathname.includes('/delivery')) {
            this.page = 'delivery';
            this.deliveryState.patientId = url.searchParams.get('patient') || this.triagePatients[0]?.id || '';
            this.initDeliveryView();
          }
        },
        revenueRecoveryMultiplier() {
          return this.finance.enableRecovery ? 1.15 : 1;
        },
        applyRevenueRecovery(value) {
          return value * this.revenueRecoveryMultiplier();
        },
        monthlyRecurringPerPatient() {
          return this.finance.rate98977 + this.finance.rate98980;
        },
        pilotPatientCount() {
          return this.finance.startPharmacies * this.finance.patientsPerPharmacy;
        },
        totalRiskMix() {
          return this.finance.riskMix.red + this.finance.riskMix.yellow + this.finance.riskMix.green;
        },
        normalizeRiskMix(changed) {
          const mix = this.finance.riskMix;
          const clamp = (value) => Math.min(100, Math.max(0, Math.round(value)));
          mix[changed] = clamp(mix[changed]);
          const keys = ['red', 'yellow', 'green'];
          const others = keys.filter(key => key !== changed);
          let remaining = 100 - mix[changed];
          if (remaining <= 0) {
            mix[others[0]] = 0;
            mix[others[1]] = 0;
            return;
          }
          const currentSum = others.reduce((sum, key) => sum + mix[key], 0);
          if (currentSum === 0) {
            mix[others[0]] = Math.round(remaining / 2);
            mix[others[1]] = remaining - mix[others[0]];
            return;
          }
          mix[others[0]] = Math.round((mix[others[0]] / currentSum) * remaining);
          mix[others[1]] = remaining - mix[others[0]];
          mix[others[0]] = clamp(mix[others[0]]);
          mix[others[1]] = clamp(mix[others[1]]);
        },
        blendedAvgMinutes() {
          const mix = this.finance.riskMix;
          const minutes = this.finance.riskMinutes;
          return ((mix.red * minutes.red) + (mix.yellow * minutes.yellow) + (mix.green * minutes.green)) / 100;
        },
        patientsPerNp() {
          const avgMinutes = this.blendedAvgMinutes();
          if (!avgMinutes || avgMinutes <= 0) return 0;
          return 6720 / avgMinutes;
        },
        npRequiredForPatients(totalPatients) {
          if (totalPatients <= 0) return 0;
          const capacity = this.patientsPerNp();
          if (capacity <= 0) return 0;
          return Math.max(1, Math.ceil(totalPatients / capacity));
        },
        npLoadForPatients(totalPatients) {
          const npCount = this.npRequiredForPatients(totalPatients);
          if (npCount <= 0) return 0;
          return totalPatients / npCount;
        },
        npLoadStatus() {
          const load = this.npLoadForPatients(this.pilotPatientCount());
          if (load > 380) {
            return {
              label: 'RED',
              className: 'bg-rose-50 text-rose-700 border-rose-200',
              note: 'Consider adding NP headcount'
            };
          }
          if (load >= 300) {
            return {
              label: 'YELLOW',
              className: 'bg-amber-50 text-amber-700 border-amber-200',
              note: ''
            };
          }
          return {
            label: 'GREEN',
            className: 'bg-emerald-50 text-emerald-700 border-emerald-200',
            note: ''
          };
        },
        npLaborCostForPatients(totalPatients) {
          return this.npRequiredForPatients(totalPatients) * this.finance.npMonthlyCost;
        },
        riskStatus(patient) {
          if (!patient) return 'green';
          return (patient.riskStatus || 'GREEN').toLowerCase();
        },
        riskBadge(patient) {
          const status = this.riskStatus(patient);
          if (status === 'red') return 'bg-white text-rose-700 border border-rose-200';
          if (status === 'yellow') return 'bg-white text-amber-700 border border-amber-200';
          return 'bg-white text-emerald-700 border border-emerald-200';
        },
        riskRowClass(patient) {
          return 'risk-row bg-[#ffffff] border-[#E2E8F0] hover:bg-[#F0F4FF]';
        },
        lifecycleStages(patient) {
          if (!patient) return [];
          const completed = [
            patient.lifecycleStage?.includes('consent'),
            patient.lifecycleStage?.includes('delivered'),
            patient.adherenceDays >= patient.adherenceTarget,
            patient.npMinutesLogged >= patient.npMinutesTarget,
            patient.billingStatus === 'READY_TO_BILL'
          ];
          const firstIncomplete = completed.findIndex(done => !done);
          const currentIndex = firstIncomplete === -1 ? -1 : firstIncomplete;
          const buildStage = (label, emoji, index, pulse = false) => {
            const isCompleted = completed[index];
            const isCurrent = !isCompleted && currentIndex === index;
            const icon = isCompleted ? 'âœ…' : emoji;
            return { label: `${icon} ${label}`, status: isCompleted ? 'completed' : (isCurrent ? 'current' : 'future'), pulse };
          };
          return [
            buildStage('Consent', 'ðŸ§¾', 0),
            buildStage('Delivered', 'ðŸ“¦', 1),
            buildStage(`${patient.adherenceDays}/${patient.adherenceTarget} Days`, 'ðŸ“±', 2),
            buildStage(`${patient.npMinutesLogged}/${patient.npMinutesTarget} Min`, 'â±', 3),
            buildStage('BILL READY', 'ðŸ’°', 4, patient.billingStatus === 'READY_TO_BILL')
          ];
        },
        stagePillClass(stage) {
          if (stage.status === 'completed') return `bg-[#16A34A] text-white ${stage.pulse ? 'pulse-green' : ''}`;
          if (stage.status === 'current') return 'bg-amber-50 text-amber-700 border border-amber-200';
          return 'bg-white text-[#64748B] border border-slate-200';
        },
        critical98977(patient) {
          return patient && (patient.adherenceDays === 14 || patient.adherenceDays === 15);
        },
        needs98977(patient) {
          return patient && patient.adherenceDays < patient.adherenceTarget;
        },
        is98977Urgent(patient) {
          return patient && this.daysRemainingInCycle(patient) <= 2 && this.needs98977(patient);
        },
        daysRemainingInCycle(patient) {
          if (!patient) return 0;
          return Math.max(0, patient.adherenceTarget - patient.adherenceDays);
        },
        billingMinutes(patient) {
          if (!patient) return 0;
          return patient.npMinutesLogged || 0;
        },
        billingReady(patient) {
          if (!patient) return false;
          return patient.billingStatus === 'READY_TO_BILL' || this.billingMinutes(patient) >= (patient.npMinutesTarget || 20);
        },
        billingProgress(patient) {
          const target = patient?.npMinutesTarget || 20;
          return Math.min(100, (this.billingMinutes(patient) / target) * 100);
        },
        billingColor(patient) {
          return this.billingReady(patient) ? '#16A34A' : '#D97706';
        },
        paginatedPatients() {
          const patients = this.sortedPatients();
          const start = (this.triagePage - 1) * this.triagePerPage;
          return patients.slice(start, start + this.triagePerPage);
        },
        triageTotalPages() {
          return Math.max(1, Math.ceil(this.triagePatients.length / this.triagePerPage));
        },
        triagePageRange() {
          const total = this.triagePatients.length;
          if (total === 0) {
            return { start: 0, end: 0, total: 0 };
          }
          const start = (this.triagePage - 1) * this.triagePerPage + 1;
          const end = Math.min(total, this.triagePage * this.triagePerPage);
          return { start, end, total };
        },
        setTriagePage(page) {
          const total = this.triageTotalPages();
          const nextPage = Math.min(Math.max(1, page), total);
          this.triagePage = nextPage;
        },
        nextTriagePage() {
          this.setTriagePage(this.triagePage + 1);
        },
        prevTriagePage() {
          this.setTriagePage(this.triagePage - 1);
        },
        sortedPatients() {
          const order = { red: 1, yellow: 2, green: 3 };
          const patients = [...this.triagePatients];
          if (this.triageSort === 'adherence') {
            return patients.sort((a, b) => {
              if (b.adherenceDays !== a.adherenceDays) return b.adherenceDays - a.adherenceDays;
              return a.name.localeCompare(b.name);
            });
          }
          if (this.triageSort === 'billing') {
            return patients.sort((a, b) => {
              const readyDiff = Number(this.billingReady(b)) - Number(this.billingReady(a));
              if (readyDiff !== 0) return readyDiff;
              if (this.billingMinutes(b) !== this.billingMinutes(a)) return this.billingMinutes(b) - this.billingMinutes(a);
              return a.name.localeCompare(b.name);
            });
          }
          return patients.sort((a, b) => {
            const statusA = this.riskStatus(a);
            const statusB = this.riskStatus(b);
            if (order[statusA] !== order[statusB]) return order[statusA] - order[statusB];
            return a.name.localeCompare(b.name);
          });
        },
        openPatient(patient) {
          this.activePatient = patient;
          this.showPatientPanel = true;
          this.encounterApproved = false;
          this.encounterStep = 1;
          this.identityConfirmed = false;
          this.vitalsReviewed = false;
          this.aiReviewed = false;
          this.logAcknowledged = false;
          this.pendingAuditHash = '';
          this.resetClinicalTimer();
          this.startClinicalTimer();
          this.aiDraftMinutes = 0;
          this.aiSummary = '';
          this.aiFlags = [];
          this.aiUrgent = false;
          this.callGlassHealth(patient);
          this.buildTwilioAuditLog(patient);
        },
        encounterProgress() {
          if (this.encounterSteps.length <= 1) return 0;
          return Math.round(((this.encounterStep - 1) / (this.encounterSteps.length - 1)) * 100);
        },
        canAdvanceEncounter() {
          if (this.encounterStep === 1) return this.identityConfirmed;
          if (this.encounterStep === 2) return this.vitalsReviewed;
          if (this.encounterStep === 3) return !this.aiLoading && this.aiSummary && this.aiReviewed;
          if (this.encounterStep === 4) return this.aiDraftNote && this.aiDraftNote.trim().length > 0;
          return false;
        },
        canApproveEncounter() {
          return this.encounterStep === 5 && this.logAcknowledged && this.aiDraftNote && this.aiDraftNote.trim().length > 0;
        },
        async prepareEncounterHash() {
          if (!this.aiDraftNote) {
            this.pendingAuditHash = '';
            return;
          }
          const timestamp = new Date().toISOString();
          const npName = 'NP Reviewer';
          const auditHash = await this.sha256Hex(`${this.aiDraftNote.trim()}${timestamp}${npName}`);
          this.pendingAuditHash = auditHash.slice(0, 18);
        },
        nextEncounterStep() {
          if (!this.canAdvanceEncounter()) {
            this.notify('Complete this step before advancing.');
            return;
          }
          this.encounterStep = Math.min(this.encounterSteps.length, this.encounterStep + 1);
          if (this.encounterStep === 5) {
            this.prepareEncounterHash();
          }
        },
        prevEncounterStep() {
          this.encounterStep = Math.max(1, this.encounterStep - 1);
        },
        openContactOverlay(patient) {
          if (!patient) return;
          this.contactPatient = patient;
          this.activePatient = patient;
          this.contactSid = this.generateTwilioSid();
          this.contactTimestamp = new Date().toLocaleString('en-US', { month: 'short', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(',', ' â€”');
          if (!patient.auditLog) patient.auditLog = [];
          patient.auditLog.unshift({
            timestamp: this.contactTimestamp,
            type: "SYNC INTERACTION",
            typeBadge: "bg-teal-700",
            description: `Synchronous interaction logged via Communication Overlay. Twilio SID: ${this.contactSid}.`,
            hashId: `SHA:${this.contactSid}`,
            icon: "ðŸ“ž"
          });
          this.showContactOverlay = true;
        },
        closeContactOverlay() {
          this.showContactOverlay = false;
        },
        closePatientPanel() {
          if (!this.confirmLeaveEncounter()) return;
          this.showPatientPanel = false;
          this.stopClinicalTimer();
        },
        toggleMonitoring(patient) {
          if (!patient) return;
          patient.monitoring = patient.monitoring === 'SMS' ? 'Voice/IVR' : 'SMS';
        },
        engagementLogs(patient) {
          if (!patient) return [];
          if (patient.monitoring === 'SMS') return patient.smsLogs || [];
          return (patient.ivrLogs || []).map(entry => ({
            ...entry,
            detail: 'IVR System: Voice Call Successful (Key 1 Pressed)'
          }));
        },
        sparklinePoints(series, width = 160, height = 48, padding = 4) {
          if (!series || !series.length) return '';
          const min = Math.min(...series);
          const max = Math.max(...series);
          const range = max - min || 1;
          const step = (width - (padding * 2)) / Math.max(1, series.length - 1);
          return series.map((value, idx) => {
            const x = padding + (idx * step);
            const y = height - padding - ((value - min) / range) * (height - (padding * 2));
            return `${x},${y}`;
          }).join(' ');
        },
        latestTrendValue(series) {
          if (!series || !series.length) return 'â€”';
          return series[series.length - 1];
        },
        trendDelta(series) {
          if (!series || series.length < 2) return '0';
          const delta = series[series.length - 1] - series[0];
          const sign = delta > 0 ? '+' : '';
          return `${sign}${delta}`;
        },
        vitalsDeltaFlag(patient, type) {
          if (!patient) return { label: '', class: 'text-[#64748B]' };
          if (type === 'weight') {
            const delta = patient.weight[patient.weight.length - 1] - patient.weight[0];
            if (delta >= 8) {
              return { label: `Warning: Rapid weight gain detected (+${delta} lbs/7d)`, class: 'text-rose-600' };
            }
            if (delta >= 4) {
              return { label: `Caution: Weight trending up (+${delta} lbs/7d)`, class: 'text-amber-600' };
            }
            if (delta <= -4) {
              return { label: `Improving: Weight trending down (${delta} lbs/7d)`, class: 'text-emerald-600' };
            }
            return { label: `AI Flag: Weight stable (${delta > 0 ? '+' : ''}${delta} lbs/7d)`, class: 'text-[#0F766E]' };
          }
          const delta = patient.systolicBp[patient.systolicBp.length - 1] - patient.systolicBp[0];
          if (delta >= 15) {
            return { label: `Warning: BP rising rapidly (+${delta} mmHg systolic)`, class: 'text-rose-600' };
          }
          if (delta >= 8) {
            return { label: `Caution: BP trending upward (+${delta} mmHg systolic)`, class: 'text-amber-600' };
          }
          if (delta <= -8) {
            return { label: `Improving: BP trending down (${delta} mmHg systolic)`, class: 'text-emerald-600' };
          }
          return { label: `AI Flag: BP stable (${delta > 0 ? '+' : ''}${delta} mmHg systolic)`, class: 'text-[#2563EB]' };
        },
        timerDisplay() {
          const minutes = Math.floor(this.timerSeconds / 60);
          const seconds = this.timerSeconds % 60;
          return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        },
        timerMinutes() {
          return Math.floor(this.timerSeconds / 60);
        },
        startClinicalTimer() {
          if (this.timerRunning) return;
          if (!this.showPatientPanel || !this.activePatient) return;
          this.timerRunning = true;
          this.timerInterval = setInterval(() => {
            if (!this.showPatientPanel || !this.activePatient) {
              this.stopClinicalTimer();
              return;
            }
            this.timerSeconds += 1;
          }, 1000);
        },
        stopClinicalTimer() {
          if (this.timerInterval) {
            clearInterval(this.timerInterval);
            this.timerInterval = null;
          }
          this.timerRunning = false;
        },
        resetClinicalTimer() {
          this.stopClinicalTimer();
          this.timerSeconds = 0;
        },
        totalMinutes(patient) {
          if (!patient) return 0;
          return patient.npMinutesLogged || 0;
        },
        appendLogEntry(patient, minutes, note, auditHash = '') {
          if (!patient) return;
          const entry = {
            id: Date.now() + Math.floor(Math.random() * 1000),
            timestamp: new Date().toISOString().slice(0, 16).replace('T', ' '),
            minutes,
            note,
            hashed: true,
            auditHash
          };
          if (!patient.narrativeLogs) patient.narrativeLogs = [];
          patient.narrativeLogs.unshift(entry);
          patient.npMinutesLogged = (patient.npMinutesLogged || 0) + minutes;
        },
        generateAuditHash() {
          const random = Math.floor(Math.random() * 1e6).toString().padStart(6, '0');
          return `qcrx_hash_${random}`;
        },
        generateTwilioSid() {
          const randomChunk = Math.random().toString(16).slice(2, 10).toUpperCase();
          const timeChunk = Date.now().toString(16).slice(-8).toUpperCase();
          return `SM${randomChunk}${timeChunk}`;
        },
        quickDocument(label) {
          if (!this.activePatient) return;
          const note = label === 'Adjusted Schedule'
            ? 'Adjusted medication schedule'
            : `${label} documented.`;
          this.timerSeconds += 120;
          const auditHash = this.generateAuditHash();
          this.appendLogEntry(this.activePatient, 2, note, auditHash);
          this.notify(`${label} logged (+2 mins).`);
        },
        draftNarrative() {
          if (!this.activePatient) return;
          this.aiLoading = true;
          setTimeout(() => this.callGlassHealth(this.activePatient), 600);
          this.notify('Regenerating clinical draft.');
          if (this.encounterStep === 5) {
            this.prepareEncounterHash();
          }
        },
        buildDraftSentence(patient) {
          const symptomText = patient.symptomKeywords?.length ? patient.symptomKeywords.join(', ') : 'no acute symptoms';
          return `Patient flagged for ${patient.adherenceTarget - patient.adherenceDays} day deficit; initiated review of ${symptomText}.`;
        },
        buildGlassQuery(patient) {
          const symptomText = patient.symptomKeywords.length > 0
            ? `Recent reported symptoms via SMS: ${patient.symptomKeywords.join(', ')}.`
            : 'No symptom keywords reported. Patient has been adherent.';
          const bpTrend = patient.systolicBp.map((s, i) => `${s}/${patient.diastolicBp[i]}`).join(', ');
          const weightTrend = `${patient.weight.join(', ')} lbs`;
          const missedNote = patient.missedDoses > 0
            ? `Patient has missed ${patient.missedDoses} dose(s) in the current cycle. Last missed: ${patient.lastMissed}.`
            : 'Patient has been fully adherent this cycle.';

          return {
            query: `
              You are assisting a nurse practitioner (NP) conducting a monthly Remote Therapeutic Monitoring (RTM) review under CMS CPT code 98980. Generate:
              1. A concise AI Clinical Summary (3-4 sentences) assessing the patient's current status, adherence, and any concerning trends.
              2. A complete CMS-compliant RTM progress note narrative (suitable for the Audit Vault) that the NP can review, edit, and approve. The note must document: the clinical encounter, the patient's reported symptoms, vitals trend review, the NP's assessment, any interventions, and the plan. Include the RTM billing context.

              PATIENT CONTEXT:
              - Name: ${patient.name}
              - Age: ${patient.age} | DOB: ${patient.dob}
              - Diagnosis: ${patient.diagnosis} (ICD-10: ${patient.icd10})
              - Current Medications: ${patient.medications.join(', ')}
              - RTM Device/Monitoring Period: ${patient.adherenceDays} of ${patient.adherenceTarget} required days completed
              - Adherence: ${missedNote}
              - ${symptomText}
              - Blood Pressure Trend (7 days, mmHg): ${bpTrend}
              - Weight Trend (7 days, lbs): ${weightTrend}
              - NP Time Logged This Month: ${patient.npMinutesLogged} minutes (${patient.npMinutesTarget} minutes required for 98980)
              - Insurance: ${patient.coinsuranceStatus}

              FORMAT YOUR RESPONSE AS JSON:
              {
                "summary": "3-4 sentence clinical summary here",
                "narrative": "Full CMS-compliant progress note narrative here",
                "flags": ["Any urgent flags or recommendations as array of strings"],
                "billingReadiness": "READY | PENDING_MINUTES | PENDING_DATA | ESCALATE"
              }

              The narrative must be written in first-person NP voice, past tense, suitable for a medical record.
            `
          };
        },
        async callGlassHealth(patient) {
          if (!patient) return;
          this.aiLoading = true;
          this.aiSummary = '';
          this.aiDraftNote = '';
          this.aiFlags = [];
          this.aiUrgent = false;
          this.aiReviewed = false;
          const query = this.buildGlassQuery(patient);

          try {
            const response = await fetch('/.netlify/functions/glass-proxy', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(query)
            });

            if (!response.ok) {
              throw new Error(`Glass API error: ${response.status}`);
            }

            const data = await response.json();
            const raw = data.response || data.content || data.text || '';
            const jsonMatch = raw.match(/```json\n?([\s\S]*?)\n?```/);
            const jsonText = jsonMatch ? jsonMatch[1] : raw;
            let parsed;
            try {
              parsed = JSON.parse(jsonText);
            } catch {
              parsed = {
                summary: 'AI summary generated. Review narrative below.',
                narrative: raw || 'Unable to parse AI response.',
                flags: [],
                billingReadiness: 'PENDING_REVIEW'
              };
            }

            this.aiSummary = parsed.summary || '';
            this.aiDraftNote = parsed.narrative || '';
            this.aiFlags = parsed.flags || [];
            this.aiUrgent = this.aiFlags.some(flag => flag.toLowerCase().includes('urgent') || flag.toLowerCase().includes('immediate'));
          } catch (err) {
            this.aiSummary = this.getMockSummary(patient);
            this.aiDraftNote = this.getMockNarrative(patient);
            this.aiFlags = this.getMockFlags(patient);
            this.aiUrgent = this.aiFlags.some(flag => flag.toLowerCase().includes('urgent') || flag.toLowerCase().includes('immediate'));
            console.warn('Glass Health API unavailable â€” using mock narrative:', err.message);
          } finally {
            this.aiLoading = false;
            if (this.encounterStep === 5) {
              this.prepareEncounterHash();
            }
          }
        },
        getMockSummary(patient) {
          const summaries = {
            "PT-001": "Patient Garcia reports dizziness and fatigue over the past 3 days, with BP trending elevated (peak 158/98 mmHg). Three missed doses in the current 30-day cycle places 98977 fulfillment at risk. Clinical intervention indicated today to address adherence gap and symptomatic hypertension.",
            "PT-002": "Patient Smith is fully adherent with 16/16 monitoring days logged. BP has improved progressively from 138/85 to 132/82 mmHg over the past 7 days, consistent with medication efficacy. No symptom concerns reported. 98977 and 98980 thresholds met â€” ready for billing.",
            "PT-003": "Patient Johnson reports shortness of breath on Feb 17. One missed dose this cycle; 11 of 16 monitoring days logged. Weight and BP are within acceptable range. NP review recommended to assess dyspnea, confirm inhaler technique, and address adherence.",
            "PT-004": "URGENT: Patient Williams reports bilateral foot swelling and submitted HELP keyword. Weight trending upward over 7 days (+11 lbs). BP critically elevated at 170/106 mmHg. Five missed doses this cycle. Immediate NP intervention required â€” possible decompensated heart failure.",
            "PT-005": "Patient Brown is fully adherent with excellent glycemic and BP control trending over 7 days. No symptom concerns. Weight stable. All RTM thresholds met. 98977 + 98980 ready for billing. Recommend continuing current medication regimen."
          };
          return summaries[patient.id] || "AI clinical summary unavailable. Please review patient record manually.";
        },
        getMockNarrative(patient) {
          const narratives = {
            "PT-001": `RTM Monthly Management Encounter â€” CPT 98980\nDate of Service: February 20, 2026\nRendering Provider: [NP Name, NPI]\n\nI conducted a remote therapeutic monitoring review for Maria Garcia, a 73-year-old female with Type 2 Diabetes (E11.9) currently enrolled in the QCRx RTM program.\n\nAdherence Review: Patient has logged 13 of 16 required monitoring days this cycle. Three missed doses were recorded (Feb 14, 16, 18). Patient reported symptoms of dizziness and fatigue via SMS on February 18.\n\nVitals Trend: Blood pressure over the past 7 days ranged from 145/90 to 158/98 mmHg, representing an elevated and worsening trend from her baseline. Weight has been stable at 162-164 lbs.\n\nClinical Assessment: Patient's reported dizziness may be related to poorly controlled hypertension or medication non-adherence. The BP trend is concerning and warrants medication review. Metformin adherence gaps may impact glycemic control.\n\nIntervention: I contacted the patient by telephone. Patient reported that dizziness occurs in the morning and she has been forgetting her Metformin with breakfast. I provided education on the importance of consistent medication timing and the relationship between medication adherence and BP control. Patient verbalized understanding.\n\nPlan: Continue current medication regimen. Patient instructed to take all medications with meals. Follow-up RTM check in 72 hours. If dizziness persists, NP to reassess and consider BP medication adjustment.\n\nTime Documentation: 14 accumulated minutes of interactive communication this month (chart review + today's call). 6 additional minutes required to meet 98980 threshold.\n\n[NP Signature] [Date] [NPI]`,
            "PT-002": `RTM Monthly Management Encounter â€” CPT 98980\nDate of Service: February 20, 2026\nRendering Provider: [NP Name, NPI]\n\nI conducted a remote therapeutic monitoring review for James Smith, a 77-year-old male with Hypertension (I10) enrolled in the QCRx RTM program.\n\nAdherence Review: Patient has achieved full adherence with 16 of 16 monitoring days completed. No missed doses this cycle.\n\nVitals Trend: Blood pressure over the past 7 days has shown a progressive improvement from 138/85 to 132/82 mmHg, consistent with therapeutic response to Amlodipine and Losartan. Weight stable at 177-178 lbs.\n\nClinical Assessment: Patient's hypertension is well-controlled on current regimen. No adverse symptoms reported. Continued adherence to medication schedule is producing measurable clinical benefit.\n\nIntervention: Monthly RTM check-in call completed. Patient reports feeling well. No complaints of headache, dizziness, or chest pain. Reinforced the importance of low-sodium diet and continued medication adherence.\n\nPlan: Continue Amlodipine 5mg and Losartan 50mg. Maintain current monitoring frequency. Next RTM cycle to begin March 1, 2026.\n\nBilling Readiness: 22 accumulated minutes logged. CPT 98977 and 98980 thresholds met. Billing report ready for generation.\n\n[NP Signature] [Date] [NPI]`,
            "PT-004": `RTM ESCALATION NOTE â€” URGENT\nDate: February 20, 2026\nRendering Provider: [NP Name, NPI]\n\nUrgent RTM review for Patricia Williams, a 75-year-old female with Heart Failure (I50.9) enrolled in QCRx RTM.\n\nADHERENCE ALERT: Patient has missed 5 doses this cycle (Days 9, 12, 15, 17, 19). Patient submitted HELP keyword and reported bilateral foot swelling on February 19.\n\nVitals Trend: CRITICAL â€” BP trending from 155/96 to 170/106 mmHg over 7 days. Weight has increased 11 lbs in 7 days (192 â†’ 203 lbs), indicating significant fluid retention.\n\nClinical Assessment: Weight gain of 11 lbs over 7 days combined with foot swelling, worsening hypertension, and Furosemide non-adherence is consistent with decompensated heart failure. This patient requires immediate clinical intervention.\n\nAction Taken: Patient contacted by phone. Patient confirmed feet and ankles are swollen and she has been short of breath at rest since yesterday. Patient instructed to take missed Furosemide dose immediately. Patient's prescribing physician notified of clinical deterioration. Emergency services advised as a precaution.\n\nPlan: Patient advised to go to nearest ED if dyspnea worsens. Prescriber contacted for urgent medication review. QCRx monitoring frequency increased to twice daily. Follow-up call in 4 hours.\n\n[NP Signature] [Date] [NPI]`
          };
          return narratives[patient.id] || `RTM Monthly Management Encounter â€” CPT 98980\nDate of Service: February 20, 2026\n\nI conducted a remote therapeutic monitoring review for ${patient.name}. Patient is enrolled in the QCRx RTM program for ${patient.diagnosis}. Adherence reviewed, vitals trend assessed, and patient contact completed per RTM protocol. Plan documented and monitoring continues.\n\n[NP Signature] [Date] [NPI]`;
        },
        getMockFlags(patient) {
          const flags = {
            "PT-001": ["Elevated BP trend with dizziness", "3 missed doses in current cycle"],
            "PT-002": [],
            "PT-003": ["Shortness of breath reported on Feb 17"],
            "PT-004": ["URGENT: Possible decompensated heart failure", "Weight gain +11 lbs in 7 days", "Critical BP 170/106"],
            "PT-005": []
          };
          return flags[patient.id] || [];
        },
        async approveAndLog() {
          if (!this.activePatient || !this.aiDraftNote.trim()) {
            this.notify('Review the AI draft before logging.');
            return;
          }
          if (!this.canApproveEncounter()) {
            this.notify('Confirm log & hash before approval.');
            return;
          }
          const minutes = this.timerMinutes();
          const timestamp = new Date().toISOString();
          const npName = 'NP Reviewer';
          const auditHash = await this.sha256Hex(`${this.aiDraftNote.trim()}${timestamp}${npName}`);
          this.appendLogEntry(this.activePatient, minutes, this.aiDraftNote.trim(), auditHash);
          if (!this.activePatient.auditLog) this.activePatient.auditLog = [];
          this.activePatient.auditLog.unshift({
            timestamp: `${this.activePatient.lastContact} â€” 10:30 AM`,
            type: "NP NARRATIVE APPROVED",
            typeBadge: "bg-purple-700",
            description: "NP approved AI-drafted narrative and logged RTM encounter minutes.",
            hashId: `SHA:${auditHash}`,
            icon: "ðŸ©º"
          });
          if (this.activePatient.npMinutesLogged >= this.activePatient.npMinutesTarget) {
            this.activePatient.billingStatus = "READY_TO_BILL";
          }
          this.aiDraftMinutes = 0;
          this.encounterApproved = true;
          this.notify(`âœ… Narrative approved and logged to Audit Vault. Hash: ${auditHash.slice(0, 12)}...`);
          this.showPatientPanel = false;
          this.page = 'clinical';
          this.stopClinicalTimer();
        },
        addNarrative() {
          if (!this.activePatient || !this.newLog.trim()) {
            this.notify('Add a narrative note before logging.');
            return;
          }
          this.appendLogEntry(this.activePatient, this.newMinutes || 0, this.newLog.trim());
          this.newLog = '';
          this.newMinutes = 5;
          this.notify('Narrative entry sealed and verified.');
        },
        async sha256Hex(message) {
          const msgBuffer = new TextEncoder().encode(message);
          const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        },
        async buildTwilioAuditLog(patient) {
          if (!patient) {
            this.twilioAuditLog = [];
            return;
          }
          const smsEntries = (patient.smsLogs || []).map(entry => ({
            timestamp: entry.timestamp,
            channel: 'SMS',
            detail: entry.detail,
            source: `${patient.id}-sms-${entry.timestamp}`
          }));
          const voiceEntries = (patient.ivrLogs || []).map(entry => ({
            timestamp: entry.timestamp,
            channel: 'Voice/IVR',
            detail: entry.detail,
            source: `${patient.id}-ivr-${entry.timestamp}`
          }));
          const combined = [...smsEntries, ...voiceEntries];
          const hashes = await Promise.all(combined.map(item => this.sha256Hex(`${item.source}-${item.channel}`)));
          this.twilioAuditLog = combined.map((item, idx) => ({
            ...item,
            hash: `SHA:${hashes[idx].slice(0, 20)}...`
          }));
        },
        truncateHash(hashId) {
          if (!hashId) return '';
          return hashId.length > 28 ? `${hashId.slice(0, 28)}...` : hashId;
        },
        parseAuditTimestamp(timestamp) {
          if (!timestamp) return 0;
          const normalized = timestamp.replace('â€”', '').replace(/\s+/g, ' ').trim();
          const parsed = Date.parse(normalized);
          return Number.isNaN(parsed) ? 0 : parsed;
        },
        auditLogEntries(patient) {
          if (!patient?.auditLog) return [];
          return [...patient.auditLog].sort((a, b) => this.parseAuditTimestamp(b.timestamp) - this.parseAuditTimestamp(a.timestamp));
        },
        generateAuditLog(patient) {
          const baseLog = [
            {
              timestamp: `${patient.consentDate} â€” 09:14 AM`,
              type: "CONSENT",
              typeBadge: "bg-blue-700",
              description: "Patient replied AGREE to RTM enrollment SMS. Consent logged.",
              hashId: `SHA:${patient.consentTwilioSid}`,
              icon: "ðŸ”"
            },
            {
              timestamp: `${patient.consentDate} â€” 09:14 AM`,
              type: "98975 BILLED",
              typeBadge: "bg-green-700",
              description: "CPT 98975 triggered â€” Setup & Education. Amount: $19.65 billed to Medicare.",
              hashId: `SHA:98975-${patient.id}-${patient.enrollmentDate.replace(/\s/g, '')}`,
              icon: "ðŸ’°"
            }
          ];
          const deliveryLog = patient.deliveryVerified ? [{
            timestamp: patient.deliveryTimestamp,
            type: "DELIVERY",
            typeBadge: "bg-teal-700",
            description: `Hand-to-Hand Verified. GPS: ${patient.deliveryGps}. RxSafe Batch: ${patient.rxsafeBatchId}.`,
            hashId: `SHA:GPS-${patient.deviceId}-${patient.rxsafeBatchId}`,
            icon: "ðŸ“¦"
          }] : [];
          const smsLogs = Array.from({ length: patient.adherenceDays }, (_, i) => ({
            timestamp: `Feb ${(i + 2).toString().padStart(2, '0')}, 2026 â€” 09:00 AM`,
            type: "SMS LOG",
            typeBadge: "bg-blue-900",
            description: "Daily adherence ping sent. Patient replied: TAKEN. Twilio SID logged.",
            hashId: `SHA:SMS-${patient.id}-DAY${i + 1}`,
            icon: "ðŸ“±"
          }));
          const npLogs = patient.npMinutesLogged > 0 ? [{
            timestamp: `${patient.lastContact} â€” 10:30 AM`,
            type: "NP SESSION",
            typeBadge: "bg-purple-700",
            description: `NP reviewed chart and patient record. Session time: ${patient.npMinutesLogged} min logged toward 98980. AI narrative approved.`,
            hashId: `SHA:NP-${patient.id}-${patient.lastContact.replace(/\s/g, '')}`,
            icon: "ðŸ©º"
          }] : [];
          const billingLogs = patient.billingStatus === "READY_TO_BILL" ? [{
            timestamp: "Feb 20, 2026 â€” 08:00 AM",
            type: "BILL READY",
            typeBadge: "bg-green-600",
            description: "All thresholds met. 98977 + 98980 flagged for billing report generation.",
            hashId: `SHA:BILL-${patient.id}-FEB2026`,
            icon: "ðŸ’°"
          }] : [];
          return [...baseLog, ...deliveryLog, ...smsLogs, ...npLogs, ...billingLogs];
        },
        readyToBillCount() {
          return this.triagePatients.filter(p => this.billingReady(p)).length;
        },
        watchlistCount() {
          return this.triagePatients.filter(p => this.critical98977(p)).length;
        },
        coinsuranceBadge(patient) {
          const status = patient?.coinsuranceStatus || '';
          if (status.includes('MEDIGAP') || status.includes('$0 copay')) {
            return { label: 'âœ… $0 Copay (Medigap)', class: 'bg-emerald-50 text-emerald-700 border border-emerald-100' };
          }
          if (status.includes('ORIGINAL MEDICARE')) {
            return { label: 'âš  ~$21/mo Copay', class: 'bg-amber-50 text-amber-700 border border-amber-100' };
          }
          if (status.includes('MEDICARE ADVANTAGE')) {
            return { label: 'â„¹ Verify Copay', class: 'bg-blue-50 text-blue-700 border border-blue-100' };
          }
          return { label: 'â„¹ Verify Copay', class: 'bg-slate-100 text-slate-600 border border-slate-200' };
        },
        deliveryPatient() {
          return this.triagePatients.find(p => p.id === this.deliveryState.patientId);
        },
        initDeliveryView() {
          this.deliveryState.gpsStatus = 'loading';
          this.deliveryState.coords = '';
          this.deliveryState.confirmed = false;
          navigator.geolocation.getCurrentPosition(
            position => {
              const { latitude, longitude } = position.coords;
              this.deliveryState.lat = latitude;
              this.deliveryState.lng = longitude;
              this.deliveryState.coords = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
              this.deliveryState.gpsStatus = 'ready';
            },
            () => {
              this.deliveryState.gpsStatus = 'error';
            }
          );
        },
        async confirmDelivery() {
          if (this.deliveryState.confirmed) return;
          const patient = this.deliveryPatient();
          const timestamp = new Date().toISOString();
          const hash = await this.sha256Hex(`${patient?.id || ''}${patient?.rxsafeBatchId || ''}${timestamp}`);
          this.deliveryState.timestamp = timestamp;
          this.deliveryState.hashId = hash;
          this.deliveryState.confirmed = true;
          if (patient) {
            patient.deliveryVerified = true;
            patient.deliveryTimestamp = new Date().toLocaleString('en-US', { month: 'short', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(',', ' â€”');
            patient.deliveryGps = this.deliveryState.coords;
            patient.deliveryStatus = 'Completed';
          }
          const ledger = this.pharmacyPatients.find(p => p.id === patient?.id);
          if (ledger) {
            ledger.gpsVerified = true;
            ledger.deliveryTimestamp = patient.deliveryTimestamp;
            ledger.deliveryGps = patient.deliveryGps;
            ledger.deliveryStatus = 'Completed';
          }
        },
        logisticsCredits() {
          return this.pharmacyPatients.filter(p => p.gpsVerified).length * this.finance.pharmacyReimbursementRate;
        },
        deliverySummary() {
          const summary = { pending: 0, inTransit: 0, completed: 0 };
          this.pharmacyPatients.forEach(patient => {
            if (patient.deliveryStatus === 'Completed' || patient.gpsVerified) {
              summary.completed += 1;
            } else if (patient.deliveryStatus === 'In Transit') {
              summary.inTransit += 1;
            } else {
              summary.pending += 1;
            }
          });
          return summary;
        },
        deliveryStatusBadge(patient) {
          const status = patient?.deliveryStatus || (patient?.gpsVerified ? 'Completed' : 'Pending');
          if (status === 'Completed' || patient?.gpsVerified) {
            return { label: 'Completed', class: 'bg-emerald-50 text-emerald-700 border border-emerald-100' };
          }
          if (status === 'In Transit') {
            return { label: 'In Transit', class: 'bg-blue-50 text-blue-700 border border-blue-100' };
          }
          return { label: 'Pending', class: 'bg-slate-100 text-slate-500 border border-slate-200' };
        },
        launchDeliveryVerification(patient) {
          if (!patient) return;
          if (!patient.gpsVerified && patient.deliveryStatus === 'Pending') {
            patient.deliveryStatus = 'In Transit';
          }
          this.deliveryState.patientId = patient.id;
          this.page = 'delivery';
          this.initDeliveryView();
        },
        setupInactivityTimer() {
          const resetHandler = this.resetInactivityTimer.bind(this);
          ['mousemove', 'mousedown', 'keydown', 'scroll', 'touchstart'].forEach(eventName => {
            window.addEventListener(eventName, resetHandler, { passive: true });
          });
          this.resetInactivityTimer();
        },
        confirmLeaveEncounter() {
          if (!this.showPatientPanel) return true;
          if (this.encounterApproved || this.timerSeconds === 0) return true;
          return window.confirm('Unsaved session time will be lost');
        },
        resetInactivityTimer() {
          if (this.inactivityTimer) clearTimeout(this.inactivityTimer);
          this.inactivityTimer = setTimeout(() => this.handleInactivityTimeout(), this.inactivityTimeoutMs);
        },
        handleInactivityTimeout() {
          this.goToLogin(true);
          this.notify('Session timed out after 15 minutes of inactivity.');
        },
        goToLogin(resetPatient = false) {
          if (!this.confirmLeaveEncounter()) return;
          this.page = 'login';
          this.showClinicalDrawer = false;
          this.tourActive = false;
          this.tourHighlight = '';
          this.showEnrollModal = false;
          this.showBulkModal = false;
          this.showPatientPanel = false;
          if (resetPatient) this.activePatient = null;
          this.stopClinicalTimer();
        },
        currentTourSteps() {
          if (this.tourPersona === 'clinical') {
            return [
              { id: 'triage-queue', title: 'Triage Queue', text: 'Review risk-ranked patients and open AI-assisted encounters.' },
              { id: 'risk-badges', title: 'Risk Badges', text: 'Scan RED/YELLOW/GREEN tiers to prioritize outreach.' },
              { id: 'billing-readiness', title: 'Billing Readiness', text: 'Track who has met RTM minute thresholds for 98980.' },
              { id: 'audit-vault', title: 'Audit Vault', text: 'Immutable logs seal consent, deliveries, and clinical actions.' },
              { id: 'load-demo-button', title: 'Load Demo Patients', text: 'Seed a realistic queue for demos and walkthroughs.' }
            ];
          }
          if (this.tourPersona === 'pharmacy') {
            return [
              { id: 'pharmacy-ledger', title: 'Active Deliveries', text: 'Monitor todayâ€™s delivery pipeline and counts.' },
              { id: 'logistics-ledger', title: 'Logistics Ledger', text: 'Track monthly GPS delivery credits.' },
              { id: 'bulk-intake', title: 'Bulk Intake', text: 'Upload and map patient rosters for enrollment.' },
              { id: 'gps-verify-button', title: 'GPS Verify', text: 'Launch hand-to-hand GPS verification per delivery.' }
            ];
          }
          if (this.tourPersona === 'finance') {
            return [
              { id: 'finance-modeler', title: 'Revenue Sliders', text: 'Adjust growth and cost assumptions in real time.' },
              { id: 'finance-output', title: 'Output Cards', text: 'Review revenue stack and live projections.' },
              { id: 'finance-chart', title: '24-Month Chart', text: 'Review the cumulative revenue curve.' },
              { id: 'finance-download', title: 'Download Compliance Bundle', text: 'Export billing compliance summaries.' }
            ];
          }
          return [];
        },
        currentTourStep() {
          const steps = this.currentTourSteps();
          return steps[this.tourStepIndex] || { id: '', title: '', text: '' };
        },
        updateTourPosition() {
          const step = this.currentTourStep();
          const el = document.getElementById(step.id);
          if (!el) {
            this.tourStyle = 'top: 20px; left: 20px;';
            this.tourHighlight = '';
            return;
          }
          const rect = el.getBoundingClientRect();
          const tooltipWidth = 280;
          const padding = 16;
          const left = Math.min(Math.max(padding, rect.left), window.innerWidth - tooltipWidth - padding);
          const top = Math.min(rect.bottom + 12, window.innerHeight - 160);
          this.tourStyle = `top: ${top}px; left: ${left}px;`;
          this.tourHighlight = step.id;
        },
        startTour(persona) {
          this.tourPersona = persona;
          this.tourStepIndex = 0;
          this.tourActive = true;
          this.$nextTick(() => this.updateTourPosition());
        },
        nextTourStep() {
          if (this.tourStepIndex + 1 >= this.currentTourSteps().length) {
            this.endTour();
            return;
          }
          this.tourStepIndex += 1;
          this.$nextTick(() => this.updateTourPosition());
        },
        skipTour() {
          this.endTour();
        },
        endTour() {
          if (this.tourPersona) {
            localStorage.setItem(`qcrxTourDone-${this.tourPersona}`, 'true');
          }
          this.tourActive = false;
          this.tourHighlight = '';
        },
        maybeStartTour(persona) {
          if (this.isLoading) return;
          if (!['clinical', 'pharmacy', 'finance'].includes(persona)) return;
          const done = localStorage.getItem(`qcrxTourDone-${persona}`) === 'true';
          if (!done) {
            this.startTour(persona);
          }
        },
        onPersonaChange(persona) {
          if (this.tourActive) {
            this.tourActive = false;
            this.tourHighlight = '';
          }
          this.maybeStartTour(persona);
        },
        switchPersona(target) {
          if (!target) return;
          if (!this.confirmLeaveEncounter()) return;
          this.showClinicalDrawer = false;
          this.page = target;
          this.onPersonaChange(target);
        },
        initThemePreference() {
          const saved = localStorage.getItem('qcrxTheme');
          this.themePreference = saved || 'system';
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          this.isDark = this.themePreference === 'dark' || (this.themePreference === 'system' && prefersDark);
          this.applyTheme();
          const media = window.matchMedia('(prefers-color-scheme: dark)');
          media.addEventListener('change', (event) => {
            if (this.themePreference === 'system') {
              this.isDark = event.matches;
              this.applyTheme();
            }
          });
        },
        applyTheme() {
          document.documentElement.classList.toggle('dark', this.isDark);
        },
        toggleTheme() {
          this.isDark = !this.isDark;
          this.themePreference = this.isDark ? 'dark' : 'light';
          localStorage.setItem('qcrxTheme', this.themePreference);
          this.applyTheme();
        },
        nextConsent() {
          if (this.enrollForm.step < this.consentSteps.length - 1) this.enrollForm.step += 1;
        },
        prevConsent() {
          if (this.enrollForm.step > 0) this.enrollForm.step -= 1;
        },
        submitEnrollment() {
          if (!this.enrollForm.name.trim() || !this.enrollForm.diagnosis.trim() || !this.enrollForm.coinsuranceStatus) {
            this.notify('Enter name, diagnosis, and insurance type before activation.');
            return;
          }
          const id = `PT-${Date.now()}`;
          const rxBatch = `RXSF-2026-${Math.floor(Math.random() * 90000) + 10000}-FEB`;
          const today = new Date().toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' });
          const newPatient = {
            id,
            name: this.enrollForm.name,
            dob: '01/01/1955',
            age: 71,
            address: 'Pending address verification',
            phone: '555-0100',
            diagnosis: this.enrollForm.diagnosis,
            icd10: 'TBD',
            medications: ['Pending reconciliation'],
            pharmacyNpi: '1234567890',
            deviceId: `RX-${Math.floor(Math.random() * 90000) + 10000}`,
            rxsafeBatchId: rxBatch,
            riskStatus: 'YELLOW',
            adherenceDays: 0,
            adherenceTarget: 16,
            missedDoses: 0,
            lastMissed: null,
            symptomKeywords: [],
            systolicBp: [120, 121, 120, 121, 120, 121, 120],
            diastolicBp: [80, 79, 80, 81, 80, 79, 80],
            weight: [160, 160, 160, 160, 160, 160, 160],
            deliveryVerified: false,
            deliveryTimestamp: 'Pending courier confirmation',
            deliveryGps: 'Pending GPS',
            consentDate: today,
            consentTwilioSid: `SM${Math.floor(Math.random() * 1e12)}`,
            enrollmentDate: today,
            npMinutesLogged: 0,
            npMinutesTarget: 20,
            billingStatus: '98977_PENDING',
            lifecycleStage: ['consent'],
            coinsuranceStatus: this.enrollForm.coinsuranceStatus,
            lastContact: 'just now',
            monitoring: 'SMS',
            smsLogs: [
              { id: 1, timestamp: `${today} â€” 10:20 AM`, channel: 'SMS', detail: 'Twilio SMS enrollment confirmation sent.' }
            ],
            ivrLogs: [
              { id: 1, timestamp: `${today} â€” 10:22 AM`, channel: 'IVR', detail: 'Call Successful - Key 1 Pressed' }
            ],
            narrativeLogs: [],
            auditLog: []
          };
          newPatient.auditLog = this.generateAuditLog(newPatient);
          this.triagePatients.unshift(newPatient);
          this.pharmacyPatients.unshift({
            id,
            name: newPatient.name,
            diagnosis: newPatient.diagnosis,
            gpsVerified: false,
            rxSafeBatch: rxBatch,
            deliveryTimestamp: newPatient.deliveryTimestamp,
            deliveryGps: newPatient.deliveryGps,
            deliveryStatus: 'Pending'
          });
          this.setTriagePage(1);
          this.auditTrail.unshift({
            batchId: rxBatch,
            monitoringId: `Monitor-${this.enrollForm.name.split(' ')[0].toUpperCase()}-${Math.floor(Math.random() * 9000)}`
          });
          this.notify('Enrollment captured with consent flow sealed.');
          this.closeEnroll();
        },
        closeEnroll() {
          this.showEnrollModal = false;
          this.enrollForm = { name: '', diagnosis: '', coinsuranceStatus: '', step: 0 };
        },
        openBulkModal() {
          this.showBulkModal = true;
          this.bulkUpload.mappingConfirmed = false;
        },
        closeBulkModal() {
          this.showBulkModal = false;
          this.bulkUpload.mappingConfirmed = false;
        },
        handleBulkDrop(event) {
          const file = event.dataTransfer.files[0];
          if (file) this.processBulkFile(file);
        },
        handleBulkFile(event) {
          const file = event.target.files[0];
          if (file) this.processBulkFile(file);
        },
        processBulkFile(file) {
          this.bulkUpload.fileName = file.name;
          this.bulkUpload.progress = 20;
          this.bulkUpload.mappingConfirmed = false;
          this.bulkUpload.validated = false;
          this.bulkUpload.validationSummary = { eligible: 0, ineligible: 0 };
          if (file.name.toLowerCase().endsWith('.csv') || file.type.includes('csv')) {
            const reader = new FileReader();
            reader.onload = (event) => {
              const text = event.target.result || '';
              this.parseCsvText(text);
              this.autoMapHeaders(this.bulkUpload.headers);
              this.buildBulkPreview();
              this.bulkUpload.progress = 45;
            };
            reader.readAsText(file);
          } else {
            this.simulateBulkData();
            this.autoMapHeaders(this.bulkUpload.headers);
            this.buildBulkPreview();
            this.bulkUpload.progress = 45;
          }
        },
        parseCsvText(text) {
          const lines = text.split(/\r?\n/).filter(line => line.trim().length);
          if (!lines.length) {
            this.notify('No rows detected in CSV.');
            return;
          }
          const headers = this.parseCsvLine(lines[0]).map(header => header.trim().toLowerCase());
          const rows = lines.slice(1).map((line, index) => {
            const values = this.parseCsvLine(line);
            const row = { __id: index + 1 };
            headers.forEach((header, idx) => {
              row[header] = (values[idx] || '').trim();
            });
            return row;
          });
          this.bulkUpload.headers = headers;
          this.bulkUpload.rows = rows;
          this.bulkUpload.mappingConfirmed = false;
          this.buildBulkPreview();
        },
        parseCsvLine(line) {
          const result = [];
          let current = '';
          let inQuotes = false;
          for (let i = 0; i < line.length; i += 1) {
            const char = line[i];
            if (char === '"') {
              if (inQuotes && line[i + 1] === '"') {
                current += '"';
                i += 1;
              } else {
                inQuotes = !inQuotes;
              }
              continue;
            }
            if (char === ',' && !inQuotes) {
              result.push(current);
              current = '';
              continue;
            }
            current += char;
          }
          result.push(current);
          return result;
        },
        normalizeHeader(value) {
          return (value || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        },
        scoreHeaderMatch(header, synonyms) {
          const normalized = this.normalizeHeader(header);
          let score = 0;
          synonyms.forEach(synonym => {
            const syn = this.normalizeHeader(synonym);
            if (!syn) return;
            if (normalized === syn) score = Math.max(score, 100);
            if (normalized.startsWith(syn)) score = Math.max(score, 90);
            if (normalized.includes(syn)) score = Math.max(score, 80);
            if (syn.includes(normalized)) score = Math.max(score, 70);
          });
          return score;
        },
        autoMapHeaders(headers) {
          const fields = {
            patientName: ['patient_full_name', 'patient name', 'full name', 'name', 'member name', 'patient'],
            dob: ['date_of_birth', 'dob', 'birth date', 'date of birth'],
            icd10: ['primary_diagnosis_code', 'icd10', 'icd-10', 'diagnosis code', 'primary diagnosis'],
            pharmacyId: ['pharmacy_npi_id', 'pharmacy npi', 'npi', 'pharmacy id'],
            deviceId: ['monitoring_device_id', 'device id', 'monitoring id', 'device']
          };
          const mapping = {};
          Object.keys(fields).forEach(key => {
            const scores = headers.map(header => ({
              header,
              score: this.scoreHeaderMatch(header, fields[key])
            }));
            scores.sort((a, b) => b.score - a.score);
            mapping[key] = scores[0] && scores[0].score >= 70 ? scores[0].header : '';
          });
          this.bulkUpload.mapping = { ...this.bulkUpload.mapping, ...mapping };
        },
        getMappedValue(row, key) {
          const header = this.bulkUpload.mapping[key];
          if (!header) return '';
          return row[header] || '';
        },
        confirmBulkMapping() {
          this.buildBulkPreview();
          if (this.bulkUpload.missingHeaders.length) {
            this.notify('Resolve missing mappings before confirmation.');
            return;
          }
          this.bulkUpload.mappingConfirmed = true;
          this.bulkUpload.progress = Math.max(this.bulkUpload.progress, 65);
          this.notify('Mapping confirmed. Ready to validate.');
        },
        buildBulkPreview() {
          const required = ['patient_full_name', 'date_of_birth', 'primary_diagnosis_code', 'pharmacy_npi_id', 'monitoring_device_id'];
          const mapping = this.bulkUpload.mapping;
          const missing = [];
          if (!mapping.patientName) missing.push('patient_full_name');
          if (!mapping.dob) missing.push('date_of_birth');
          if (!mapping.icd10) missing.push('primary_diagnosis_code');
          if (!mapping.pharmacyId) missing.push('pharmacy_npi_id');
          if (!mapping.deviceId) missing.push('monitoring_device_id');
          this.bulkUpload.missingHeaders = missing.length ? missing : required.filter(header => !this.bulkUpload.headers.includes(header));
          this.bulkUpload.previewRows = this.bulkUpload.rows.slice(0, 3).map(row => {
            const icd10 = this.getMappedValue(row, 'icd10');
            return {
              id: row.__id,
              patientName: this.getMappedValue(row, 'patientName') || 'â€”',
              dob: this.getMappedValue(row, 'dob') || 'â€”',
              pharmacyId: this.getMappedValue(row, 'pharmacyId') || 'â€”',
              icd10: icd10 || 'Missing',
              status: icd10 ? 'Eligible' : 'Ineligible for RTM'
            };
          });
          this.bulkUpload.validated = false;
          this.bulkUpload.validationSummary = { eligible: 0, ineligible: 0 };
          this.bulkUpload.progress = 55;
        },
        validateBulkData() {
          if (!this.bulkUpload.rows.length) {
            this.notify('Upload a file before validation.');
            return;
          }
          if (!this.bulkUpload.mappingConfirmed) {
            this.notify('Confirm column mapping before validation.');
            return;
          }
          let eligible = 0;
          let ineligible = 0;
          this.bulkUpload.rows.forEach(row => {
            if (this.getMappedValue(row, 'icd10') && this.getMappedValue(row, 'icd10').trim()) {
              eligible += 1;
            } else {
              ineligible += 1;
            }
          });
          this.bulkUpload.validationSummary = { eligible, ineligible };
          this.bulkUpload.previewRows = this.bulkUpload.previewRows.map(row => ({
            ...row,
            status: row.icd10 && row.icd10 !== 'Missing' ? 'Eligible' : 'Ineligible for RTM'
          }));
          this.bulkUpload.validated = true;
          this.bulkUpload.progress = 100;
          this.notify('Validation complete. Ineligible rows flagged.');
        },
        submitBulkIntake() {
          if (!this.bulkUpload.mappingConfirmed) {
            this.notify('Confirm mapping before submission.');
            return;
          }
          if (!this.bulkUpload.validated || this.bulkUpload.missingHeaders.length) {
            this.notify('Resolve validation and header mapping before submission.');
            return;
          }
          this.addBulkPatients(Math.min(10, this.bulkUpload.rows.length || 10));
          this.notify('Bulk intake sealed in immutable ledger.');
          this.closeBulkModal();
        },
        addBulkPatients(count) {
          const patients = this.generateBulkPatients(count);
          this.triagePatients = [...patients, ...this.triagePatients];
          const ledgerAdds = patients.map(patient => ({
            id: patient.id,
            name: patient.name,
            diagnosis: patient.diagnosis,
            gpsVerified: patient.deliveryVerified,
            rxSafeBatch: patient.rxsafeBatchId,
            deliveryTimestamp: patient.deliveryTimestamp,
            deliveryGps: patient.deliveryGps,
            deliveryStatus: patient.deliveryVerified ? 'Completed' : 'Pending'
          }));
          this.pharmacyPatients = [...ledgerAdds, ...this.pharmacyPatients];
          this.setTriagePage(1);
        },
        generateBulkPatients(count) {
          const firstNames = ['Tessa', 'Grant', 'Imani', 'Rafael', 'Selene', 'Omar', 'Ivy', 'Derek', 'Noa', 'Camila', 'Jalen', 'Rosie'];
          const lastNames = ['Carter', 'Lopez', 'Nguyen', 'Hughes', 'Patel', 'Morgan', 'Haddad', 'Kim', 'Garcia', 'Price', 'Sato', 'Bishop'];
          const meds = ['Metoprolol 25mg', 'Glipizide 5mg', 'Losartan 50mg', 'Eliquis 5mg', 'Warfarin 5mg', 'Amlodipine 5mg'];
          const symptomsPool = ['N/A', 'NAUSEA', 'FATIGUE', 'DIZZY', 'HEADACHE'];
          const streets = ['Maple', 'Oak', 'Willow', 'Pine', 'Cedar', 'Harbor', 'Ridge', 'Meadow', 'Sunset', 'Park'];
          const cities = ['Seattle, WA', 'Dallas, TX', 'Miami, FL', 'Chicago, IL', 'Denver, CO', 'Phoenix, AZ', 'Boston, MA', 'Atlanta, GA'];
          const areaCodes = ['206', '214', '305', '312', '303', '602', '617', '404'];
          return Array.from({ length: count }, (_, idx) => {
            const adherenceTarget = 16;
            const adherenceDays = Math.floor(Math.random() * adherenceTarget) + 1;
            const symptom = symptomsPool[Math.floor(Math.random() * symptomsPool.length)];
            const first = firstNames[(idx + Math.floor(Math.random() * firstNames.length)) % firstNames.length];
            const last = lastNames[(idx + Math.floor(Math.random() * lastNames.length)) % lastNames.length];
            const minutes = Math.floor(Math.random() * 26);
            const baseBp = 118 + Math.floor(Math.random() * 26);
            const baseDia = 76 + Math.floor(Math.random() * 16);
            const baseWeight = 140 + Math.floor(Math.random() * 70);
            const systolicBp = [baseBp - 2, baseBp - 1, baseBp, baseBp + 1, baseBp - 1, baseBp + 2, baseBp + 1];
            const diastolicBp = [baseDia - 1, baseDia, baseDia - 1, baseDia + 1, baseDia, baseDia + 1, baseDia];
            const weight = [baseWeight, baseWeight, baseWeight + 1, baseWeight + 1, baseWeight + 2, baseWeight + 2, baseWeight + 3];
            const streetNumber = 100 + Math.floor(Math.random() * 800);
            const street = streets[Math.floor(Math.random() * streets.length)];
            const city = cities[Math.floor(Math.random() * cities.length)];
            const area = areaCodes[Math.floor(Math.random() * areaCodes.length)];
            const dobYear = 1948 + Math.floor(Math.random() * 40);
            const dobMonth = String(Math.floor(Math.random() * 12) + 1).padStart(2, '0');
            const dobDay = String(Math.floor(Math.random() * 28) + 1).padStart(2, '0');
            const rxSafeBatch = `RXSF-2026-${Math.floor(Math.random() * 90000) + 10000}-FEB`;
            const courierHour = String(8 + Math.floor(Math.random() * 10)).padStart(2, '0');
            const courierMin = String(Math.floor(Math.random() * 60)).padStart(2, '0');
            const riskStatus = adherenceDays >= 16 ? 'GREEN' : (adherenceDays >= 12 ? 'YELLOW' : 'RED');
            return {
              id: `PT-${Date.now() + idx}`,
              name: `${first} ${last}`,
              dob: `${dobMonth}/${dobDay}/${dobYear}`,
              age: 2026 - dobYear,
              address: `${streetNumber} ${street} St, ${city}`,
              phone: `${area}-555-${String(Math.floor(1000 + Math.random() * 9000))}`,
              diagnosis: 'Hypertension (I10)',
              icd10: 'I10',
              medications: [meds[Math.floor(Math.random() * meds.length)]],
              pharmacyNpi: '1234567890',
              deviceId: `RX-${Math.floor(Math.random() * 90000) + 10000}`,
              rxsafeBatchId: rxSafeBatch,
              riskStatus,
              adherenceDays,
              adherenceTarget,
              missedDoses: Math.max(0, Math.floor(Math.random() * 4) - 1),
              lastMissed: adherenceDays < adherenceTarget ? 'Feb 19, 2026' : null,
              symptomKeywords: symptom === 'N/A' ? [] : [symptom],
              systolicBp,
              diastolicBp,
              weight,
              deliveryVerified: Math.random() > 0.4,
              deliveryTimestamp: `Feb 18, 2026 â€” ${courierHour}:${courierMin}`,
              deliveryGps: '34.0200Â° N, 118.4900Â° W',
              consentDate: 'Feb 01, 2026',
              consentTwilioSid: `SM${Math.floor(Math.random() * 1e12)}`,
              enrollmentDate: 'Feb 01, 2026',
              npMinutesLogged: minutes,
              npMinutesTarget: 20,
              billingStatus: minutes >= 20 ? 'READY_TO_BILL' : '98977_PENDING',
              lifecycleStage: ['consent', 'delivered', 'monitoring'],
              coinsuranceStatus: 'MEDIGAP â€” $0 copay',
              lastContact: 'Feb 19, 2026',
              monitoring: Math.random() > 0.5 ? 'SMS' : 'Voice/IVR',
              smsLogs: [
                { id: Date.now() + idx + 10, timestamp: '2026-02-19 08:18', channel: 'SMS', detail: 'Twilio SMS check-in delivered.' }
              ],
              ivrLogs: [
                { id: Date.now() + idx + 20, timestamp: '2026-02-19 08:24', channel: 'IVR', detail: 'Call Successful - Key 1 Pressed' }
              ],
              narrativeLogs: minutes
                ? [{ id: Date.now() + idx + 1, timestamp: '2026-02-19 08:30', minutes, note: 'Auto-imported outreach log.', hashed: true, auditHash: '' }]
                : [],
              auditLog: []
            };
          });
        },
        simulateBulkData() {
          this.bulkUpload.headers = ['patient_full_name', 'date_of_birth', 'primary_diagnosis_code', 'pharmacy_npi_id', 'monitoring_device_id'];
          this.bulkUpload.rows = [
            { __id: 1, patient_full_name: 'Tessa Carter', date_of_birth: '1978-03-12', primary_diagnosis_code: 'I50.9', pharmacy_npi_id: '1457392210', monitoring_device_id: 'MD-7781' },
            { __id: 2, patient_full_name: 'Grant Lopez', date_of_birth: '1964-08-22', primary_diagnosis_code: 'I10', pharmacy_npi_id: '1429013370', monitoring_device_id: 'MD-9910' },
            { __id: 3, patient_full_name: 'Imani Nguyen', date_of_birth: '1982-11-05', primary_diagnosis_code: 'J44.9', pharmacy_npi_id: '1699210441', monitoring_device_id: 'MD-4402' },
            { __id: 4, patient_full_name: 'Rafael Hughes', date_of_birth: '1972-01-19', primary_diagnosis_code: 'E11.9', pharmacy_npi_id: '1612339890', monitoring_device_id: 'MD-4521' },
            { __id: 5, patient_full_name: 'Selene Patel', date_of_birth: '1969-06-14', primary_diagnosis_code: 'I48.91', pharmacy_npi_id: '1447011291', monitoring_device_id: 'MD-6082' },
            { __id: 6, patient_full_name: 'Omar Morgan', date_of_birth: '1988-11-02', primary_diagnosis_code: 'I25.10', pharmacy_npi_id: '1730492219', monitoring_device_id: 'MD-3339' },
            { __id: 7, patient_full_name: 'Ivy Haddad', date_of_birth: '1976-04-25', primary_diagnosis_code: 'E78.5', pharmacy_npi_id: '1899223112', monitoring_device_id: 'MD-1177' },
            { __id: 8, patient_full_name: 'Derek Kim', date_of_birth: '1962-09-30', primary_diagnosis_code: 'I50.32', pharmacy_npi_id: '1509002114', monitoring_device_id: 'MD-9945' },
            { __id: 9, patient_full_name: 'Noa Garcia', date_of_birth: '1984-12-09', primary_diagnosis_code: 'I10', pharmacy_npi_id: '1458912340', monitoring_device_id: 'MD-5406' },
            { __id: 10, patient_full_name: 'Camila Price', date_of_birth: '1979-02-16', primary_diagnosis_code: 'E11.65', pharmacy_npi_id: '1888011223', monitoring_device_id: 'MD-7852' }
          ];
        },
        yearProjection(year) {
          const growth = year === 1 ? 2 : 5;
          const start = year === 1 ? this.finance.startPharmacies : this.finance.startPharmacies + 24;
          let total = 0;
          let pharmacies = start;
          for (let month = 1; month <= 12; month += 1) {
            const newPharmacies = month === 1 ? 0 : growth;
            pharmacies += newPharmacies;
            const patients = pharmacies * this.finance.patientsPerPharmacy;
            const onboardingRevenue = newPharmacies * this.finance.patientsPerPharmacy * this.finance.rate98975;
            const recurringRevenue = patients * this.monthlyRecurringPerPatient();
            const recoveredRevenue = this.applyRevenueRecovery(onboardingRevenue + recurringRevenue);
            const logisticsPayout = patients * this.finance.pharmacyReimbursementRate;
            const npLabor = this.npLaborCostForPatients(patients);
            total += recoveredRevenue - logisticsPayout - npLabor;
          }
          return { total, pharmaciesEnd: pharmacies };
        },
        buildMonthlyRevenueTimeline() {
          const labels = [];
          const values = [];
          let pharmacies = this.finance.startPharmacies;
          let cumulative = 0;
          for (let month = 1; month <= 24; month += 1) {
            const growth = month === 1 ? 0 : (month <= 12 ? 2 : 5);
            pharmacies += growth;
            const patients = pharmacies * this.finance.patientsPerPharmacy;
            const onboardingRevenue = growth * this.finance.patientsPerPharmacy * this.finance.rate98975;
            const recurringRevenue = patients * this.monthlyRecurringPerPatient();
            const recoveredRevenue = this.applyRevenueRecovery(onboardingRevenue + recurringRevenue);
            const logisticsPayout = patients * this.finance.pharmacyReimbursementRate;
            const npLabor = this.npLaborCostForPatients(patients);
            const netRevenue = recoveredRevenue - logisticsPayout - npLabor;
            cumulative += netRevenue;
            labels.push(`M${month}`);
            values.push(Math.round(cumulative));
          }
          return { labels, values };
        },
        updateRevenueChart() {
          if (!this.$refs.revenueChart) return;
          const { labels, values } = this.buildMonthlyRevenueTimeline();
          const dataset = {
            label: 'Cumulative Net Revenue',
            data: values,
            fill: true,
            tension: 0.35,
            borderColor: '#2563EB',
            backgroundColor: 'rgba(37, 99, 235, 0.2)',
            pointRadius: 0
          };
          if (this.revenueChart) {
            this.revenueChart.data.labels = labels;
            this.revenueChart.data.datasets = [dataset];
            this.revenueChart.update('none');
            return;
          }
          const ctx = this.$refs.revenueChart.getContext('2d');
          this.revenueChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [dataset] },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: (context) => this.formatCurrency(context.raw)
                  }
                }
              },
              scales: {
                x: { grid: { display: false }, ticks: { color: '#94A3B8' } },
                y: {
                  ticks: {
                    color: '#94A3B8',
                    callback: value => this.formatCurrency(value)
                  },
                  grid: { color: 'rgba(148, 163, 184, 0.2)' }
                }
              }
            }
          });
        },
        formatCurrency(value) {
          return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        },
        eligible98977Count() {
          return this.triagePatients.filter(patient => patient.adherenceDays >= 16).length;
        },
        eligible98980Count() {
          return this.triagePatients.filter(patient => this.billingReady(patient)).length;
        },
        eligibleSafetyNetCount() {
          return this.triagePatients.filter(patient => patient.adherenceDays < 16 && patient.adherenceDays >= 8).length;
        },
        livePilotGrossRevenue() {
          const gross = this.pilotPatientCount() * (this.finance.rate98977 + this.finance.rate98980);
          return this.applyRevenueRecovery(gross);
        },
        livePilotLogisticsPayout() {
          return this.pilotPatientCount() * this.finance.pharmacyReimbursementRate;
        },
        livePilotLaborCost() {
          return this.npLaborCostForPatients(this.pilotPatientCount());
        },
        livePilotNetProfit() {
          return this.livePilotGrossRevenue() - this.livePilotLogisticsPayout() - this.livePilotLaborCost();
        },
        complianceBundleMetrics() {
          return {
            code98977: this.eligible98977Count(),
            code98980: this.eligible98980Count(),
            code98985: this.eligibleSafetyNetCount()
          };
        },
        complianceBundleLines() {
          const metrics = this.complianceBundleMetrics();
          const dateStamp = new Date().toISOString().slice(0, 10);
          return [
            'QCRx 2026 Compliance Bundle',
            `Generated: ${dateStamp}`,
            '',
            'Total billable units:',
            `98977 Device Supply: ${metrics.code98977}`,
            `98980 Management: ${metrics.code98980}`,
            `98985/98979 Safety-Net: ${metrics.code98985}`
          ];
        },
        escapePdfText(value) {
          return value.replace(/\\/g, '\\\\').replace(/\(/g, '\\(').replace(/\)/g, '\\)');
        },
        buildCompliancePdf(lines) {
          const safeLines = lines.map(line => this.escapePdfText(line));
          const textRows = safeLines.map((line, index) => {
            const y = 742 - (index * 18);
            return `1 0 0 1 72 ${y} Tm (${line}) Tj`;
          }).join('\n');
          const content = `BT\n/F1 12 Tf\n${textRows}\nET`;
          const objects = [
            '1 0 obj << /Type /Catalog /Pages 2 0 R >> endobj',
            '2 0 obj << /Type /Pages /Kids [3 0 R] /Count 1 >> endobj',
            '3 0 obj << /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Resources << /Font << /F1 4 0 R >> >> /Contents 5 0 R >> endobj',
            '4 0 obj << /Type /Font /Subtype /Type1 /BaseFont /Helvetica >> endobj',
            `5 0 obj << /Length ${content.length} >> stream\n${content}\nendstream endobj`
          ];
          let pdf = '%PDF-1.4\n';
          const offsets = [0];
          objects.forEach(obj => {
            offsets.push(pdf.length);
            pdf += `${obj}\n`;
          });
          const xrefOffset = pdf.length;
          pdf += `xref\n0 ${objects.length + 1}\n`;
          pdf += '0000000000 65535 f \n';
          for (let i = 1; i <= objects.length; i += 1) {
            pdf += `${String(offsets[i]).padStart(10, '0')} 00000 n \n`;
          }
          pdf += `trailer << /Size ${objects.length + 1} /Root 1 0 R >>\n`;
          pdf += `startxref\n${xrefOffset}\n%%EOF`;
          return pdf;
        },
        downloadComplianceBundle() {
          const pdfContent = this.buildCompliancePdf(this.complianceBundleLines());
          const blob = new Blob([pdfContent], { type: 'application/pdf' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'QCRx-2026-Compliance-Bundle.pdf';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          this.notify('Compliance bundle downloaded.');
        },
        notify(message) {
          this.notification = message;
          setTimeout(() => (this.notification = ''), 2800);
        }
      };
    }
  </script>
</body>
</html>
